<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bet365 Elite Dashboard</title>

  <style>
    /* Bet365 Color Palette */
    :root {
      --b365-dark-green: #007355;
      --b365-bright-green: #12ed80;
      --b365-header-bg: #333333;
      --b365-body-bg: #282828;
      --b365-card-bg: #383838;
      --b365-text-white: #ffffff;
      --b365-text-gray: #bbbbbb;
      --b365-accent-yellow: #ffdf1b;
      --b365-border: #444444;
      --b365-red: #d32f2f;
      --b365-input-bg: #444444;
      --b365-input-border: #555555;
    }

    /* Hide number input spinners */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    [data-theme="light"] {
      --b365-header-bg: #e0e0e0;
      --b365-body-bg: #f0f2f5;
      --b365-card-bg: #ffffff;
      --b365-text-white: #1a1a1a;
      --b365-text-gray: #555555;
      --b365-border: #cccccc;
      --b365-input-bg: #ffffff;
      --b365-input-border: #bbbbbb;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--b365-body-bg);
      color: var(--b365-text-white);
      margin: 0;
      padding: 0;
      transition: background-color 0.3s, color 0.3s;
    }

    header {
      background-color: var(--b365-header-bg);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 3px solid var(--b365-dark-green);
      position: sticky;
      top: 0;
      z-index: 100;
      transition: background-color 0.3s;
    }

    .refresh-btn {
      background: var(--b365-dark-green);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    .refresh-btn:hover {
      background: var(--b365-bright-green);
      color: #000;
    }

    /* Navigation Tabs */
    .tab-bar {
      display: flex;
      background: linear-gradient(145deg, #1a1a2e 0%, #0d1117 100%);
      border-bottom: 2px solid rgba(18, 237, 128, 0.3);
      overflow-x: auto;
      padding: 8px 10px 0 10px;
      gap: 6px;
    }

    .tab-item {
      padding: 12px 22px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.6);
      white-space: nowrap;
      border-radius: 10px 10px 0 0;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid transparent;
      border-bottom: none;
      transition: all 0.2s ease;
      position: relative;
    }

    .tab-item:hover {
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.9);
    }

    .tab-item.active {
      background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
      color: #fff;
      border: 2px solid var(--b365-bright-green);
      border-bottom: none;
      margin-bottom: -2px;
      padding-bottom: 14px;
    }

    [data-theme="light"] .tab-item.active {
      color: var(--b365-dark-green);
      background: #fff;
    }

    .container {
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .card {
      background: var(--b365-card-bg);
      border-radius: 2px;
      margin-bottom: 20px;
      border: 1px solid var(--b365-border);
    }

    .card-header {
      background: var(--b365-header-bg);
      padding: 12px 15px;
      font-weight: bold;
      color: var(--b365-dark-green);
      /* Changed to dark green for better visibility on light? Or keep bright green? */
      border-bottom: 1px solid var(--b365-border);
      text-transform: uppercase;
      font-size: 0.85rem;
    }

    [data-theme="light"] .card-header {
      color: var(--b365-dark-green);
      background: #e8e8e8;
    }

    .card-body {
      padding: 15px;
    }

    input,
    select {
      background: var(--b365-input-bg);
      border: 1px solid var(--b365-input-border);
      color: var(--b365-text-white);
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }

    /* Compact inputs */
    input.hist-input {
      width: 40px;
      text-align: center;
      padding: 4px;
      display: inline-block;
      margin: 0 2px;
    }

    input.small-input {
      width: 60px;
      padding: 4px;
      display: inline-block;
    }

    button.action-btn {
      background: var(--b365-accent-yellow);
      color: #000;
      border: none;
      padding: 12px;
      width: 100%;
      font-weight: bold;
      cursor: pointer;
      text-transform: uppercase;
      margin-top: 10px;
    }

    button.ghost-btn {
      background: #555;
      color: #fff;
      border: none;
      padding: 8px;
      width: 100%;
      cursor: pointer;
      margin-top: 5px;
    }

    button.small-btn {
      padding: 4px 8px;
      font-size: 0.8rem;
      cursor: pointer;
      border-radius: 3px;
      border: none;
      margin-left: 5px;
    }

    button.delete-btn {
      background: #d32f2f;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      font-weight: bold;
      border-radius: 3px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th {
      text-align: left;
      background: #333;
      color: var(--b365-text-gray);
      padding: 10px;
      font-size: 0.75rem;
      text-transform: uppercase;
    }

    td {
      padding: 10px;
      border-bottom: 1px solid var(--b365-border);
      font-size: 0.9rem;
      vertical-align: middle;
    }

    .match-row {
      display: grid;
      grid-template-columns: 1fr 240px;
      padding: 15px;
      border-bottom: 1px solid var(--b365-border);
    }

    .odds-group {
      display: flex;
      gap: 8px;
    }

    .odd-box {
      background: #444;
      padding: 10px;
      text-align: center;
      flex: 1;
      cursor: pointer;
      border-radius: 2px;
      transition: 0.2s;
    }

    .odd-box:hover {
      background: #505050;
      border: 1px solid var(--b365-bright-green);
    }

    .odd-val {
      color: var(--b365-accent-yellow);
      font-weight: bold;
      display: block;
      font-size: 1.1rem;
    }

    .odd-lbl {
      font-size: 0.7rem;
      color: var(--b365-text-gray);
    }

    /* Tournament Bracket Styles - Premium Design */
    .bracket-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      padding: 40px 30px;
      background: linear-gradient(145deg, #1a1a2e 0%, #0d1117 100%);
      border-radius: 16px;
      overflow-x: auto;
      position: relative;
      min-height: 400px;
    }

    .bracket-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 50% 0%, rgba(18, 237, 128, 0.08) 0%, transparent 50%);
      pointer-events: none;
    }

    .bracket-col {
      display: flex;
      flex-direction: column;
      gap: 30px;
      position: relative;
      z-index: 1;
    }

    .bracket-col.semis {
      gap: 60px;
    }

    .bracket-col.finals {
      gap: 40px;
    }

    .bracket-match {
      background: linear-gradient(145deg, rgba(56, 56, 56, 0.9), rgba(40, 40, 40, 0.9));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 16px 20px;
      width: 220px;
      text-align: center;
      position: relative;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .bracket-match:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
      border-color: rgba(18, 237, 128, 0.3);
    }

    .bracket-match.final-match {
      background: linear-gradient(145deg, rgba(255, 215, 0, 0.15), rgba(255, 180, 0, 0.08));
      border: 2px solid var(--b365-accent-yellow);
      width: 260px;
      padding: 20px 24px;
    }

    .bracket-match.final-match::before {
      content: 'üèÜ';
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.5rem;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .bracket-match.third-match {
      background: linear-gradient(145deg, rgba(170, 170, 170, 0.1), rgba(120, 120, 120, 0.05));
      border: 1px solid rgba(170, 170, 170, 0.3);
    }

    .bracket-match.third-match::before {
      content: 'ü•â';
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.2rem;
    }

    .bracket-match .match-stage {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--b365-bright-green);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .bracket-match .match-teams {
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 10px;
      color: #fff;
    }

    .bracket-match .match-vs {
      color: #666;
      font-size: 0.8rem;
      margin: 0 6px;
    }

    .bracket-match .match-result {
      background: linear-gradient(135deg, var(--b365-dark-green), #0a5a45);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
      display: inline-block;
    }

    .bracket-match .match-result.pending {
      background: rgba(255, 255, 255, 0.1);
      color: #888;
    }

    .bracket-match .match-result.winner {
      background: linear-gradient(135deg, var(--b365-accent-yellow), #e6c700);
      color: #000;
    }

    .bracket-connector {
      width: 40px;
      height: 2px;
      background: linear-gradient(90deg, rgba(18, 237, 128, 0.5), rgba(18, 237, 128, 0.2));
      position: relative;
      align-self: center;
    }

    .bracket-connector::before,
    .bracket-connector::after {
      content: '';
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--b365-bright-green);
      top: 50%;
      transform: translateY(-50%);
    }

    .bracket-connector::before {
      left: -4px;
    }

    .bracket-connector::after {
      right: -4px;
    }

    .bracket-empty {
      color: #555;
      font-style: italic;
      text-align: center;
      padding: 40px;
    }

    #login-screen {
      max-width: 400px;
      margin: 100px auto;
    }

    /* Outright Winner Styles */
    .outright-card {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border: 2px solid var(--b365-dark-green);
      position: relative;
      overflow: hidden;
    }

    .outright-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(18, 237, 128, 0.1) 0%, transparent 50%);
      animation: pulse-glow 3s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }

    .outright-card .card-body {
      position: relative;
      z-index: 1;
    }

    .outright-card .outright-header {
      position: relative;
      z-index: 1;
    }

    @keyframes pulse-glow {

      0%,
      100% {
        opacity: 0.3;
        transform: scale(1);
      }

      50% {
        opacity: 0.6;
        transform: scale(1.05);
      }
    }

    .outright-header {
      background: linear-gradient(90deg, var(--b365-dark-green) 0%, #0a4a3a 100%);
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 2px solid var(--b365-bright-green);
    }

    .outright-header .trophy-icon {
      font-size: 1.8rem;
      animation: trophy-bounce 2s ease-in-out infinite;
    }

    @keyframes trophy-bounce {

      0%,
      100% {
        transform: translateY(0) rotate(0deg);
      }

      25% {
        transform: translateY(-3px) rotate(-5deg);
      }

      75% {
        transform: translateY(-3px) rotate(5deg);
      }
    }

    .outright-header h3 {
      margin: 0;
      color: var(--b365-accent-yellow);
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .outright-header .status-badge {
      margin-left: auto;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: bold;
      text-transform: uppercase;
    }

    .status-badge.open {
      background: var(--b365-bright-green);
      color: #000;
    }

    .status-badge.closed {
      background: var(--b365-red);
      color: #fff;
    }

    .outright-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    .outright-team-card {
      background: rgba(56, 56, 56, 0.9);
      border: 1px solid var(--b365-border);
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .outright-team-card:hover {
      transform: translateY(-3px);
      border-color: var(--b365-bright-green);
      box-shadow: 0 8px 25px rgba(18, 237, 128, 0.2);
    }

    .outright-team-card.selected {
      border-color: var(--b365-accent-yellow);
      background: rgba(255, 223, 27, 0.1);
    }

    .outright-team-card .team-name {
      font-weight: bold;
      font-size: 0.95rem;
      margin-bottom: 8px;
      color: var(--b365-text-white);
    }

    .outright-team-card .team-odds {
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--b365-accent-yellow);
    }

    .outright-team-card .team-group {
      font-size: 0.7rem;
      color: var(--b365-text-gray);
      margin-top: 5px;
    }

    .outright-bet-slip {
      background: #2a2a2a;
      padding: 15px 20px;
      border-top: 1px solid var(--b365-border);
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .outright-bet-slip .selection {
      flex: 1;
      min-width: 200px;
    }

    .outright-bet-slip .selection-label {
      font-size: 0.75rem;
      color: var(--b365-text-gray);
      text-transform: uppercase;
    }

    .outright-bet-slip .selection-value {
      font-weight: bold;
      color: var(--b365-bright-green);
    }

    .admin-outright-row {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      border-bottom: 1px solid var(--b365-border);
      gap: 15px;
    }

    .admin-outright-row:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .admin-outright-row .team-name {
      flex: 1;
      font-weight: bold;
    }

    .admin-outright-row input {
      width: 80px;
      text-align: center;
    }

    /* Leaderboard Styles */
    .leaderboard-row {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      border-bottom: 1px solid var(--b365-border);
      transition: background 0.2s;
    }

    .leaderboard-row:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .leaderboard-row.current-user {
      background: rgba(18, 237, 128, 0.1);
      border-left: 3px solid var(--b365-bright-green);
    }

    .leaderboard-rank {
      width: 40px;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .leaderboard-rank.gold {
      color: #FFD700;
    }

    .leaderboard-rank.silver {
      color: #C0C0C0;
    }

    .leaderboard-rank.bronze {
      color: #CD7F32;
    }

    .leaderboard-name {
      flex: 1;
      font-weight: 500;
    }

    .leaderboard-credits {
      font-weight: bold;
      color: var(--b365-accent-yellow);
      font-size: 1.1rem;
    }

    /* Active bet card styles */
    .active-bet-item {
      background: var(--b365-card-bg);
      border: 1px solid var(--b365-border);
      border-radius: 6px;
      padding: 12px 15px;
      margin-bottom: 10px;
    }

    .active-bet-item:last-child {
      margin-bottom: 0;
    }

    /* Notification Badge Styles */
    .notification-bell {
      position: relative;
      background: transparent;
      border: 1px solid var(--b365-text-gray);
      color: var(--b365-text-gray);
      border-radius: 50%;
      width: 35px;
      height: 35px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .notification-bell:hover {
      border-color: var(--b365-bright-green);
      color: var(--b365-bright-green);
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
      color: white;
      font-size: 0.65rem;
      font-weight: bold;
      min-width: 18px;
      height: 18px;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
      animation: badge-pulse 2s ease-in-out infinite;
      box-shadow: 0 2px 5px rgba(255, 68, 68, 0.5);
    }

    .notification-badge.hidden {
      display: none;
    }

    @keyframes badge-pulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }
    }

    .notification-dropdown {
      position: absolute;
      top: 45px;
      right: 0;
      width: 320px;
      max-height: 400px;
      background: var(--b365-card-bg);
      border: 1px solid var(--b365-border);
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      overflow: hidden;
      z-index: 1000;
      display: none;
    }

    .notification-dropdown.show {
      display: block;
    }

    .notification-dropdown-header {
      padding: 12px 15px;
      background: var(--b365-dark-green);
      color: white;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notification-list {
      max-height: 320px;
      overflow-y: auto;
    }

    .notification-item {
      padding: 12px 15px;
      border-bottom: 1px solid var(--b365-border);
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .notification-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-empty {
      padding: 30px;
      text-align: center;
      color: var(--b365-text-gray);
    }

    /* Self-Report Styles */
    .my-match-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid var(--b365-border);
      transition: background 0.2s;
    }

    .my-match-item:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .my-match-info {
      flex: 1;
    }

    .my-match-teams {
      font-weight: bold;
      font-size: 1rem;
      margin-bottom: 5px;
    }

    .my-match-meta {
      font-size: 0.75rem;
      color: var(--b365-text-gray);
    }

    .my-match-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .report-status {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: bold;
      white-space: nowrap;
    }

    .report-status.pending {
      background: #444;
      color: #999;
    }

    .report-status.reported {
      background: rgba(255, 215, 0, 0.2);
      color: #ffd700;
    }

    .report-status.matched {
      background: rgba(18, 237, 128, 0.2);
      color: var(--b365-bright-green);
    }

    .report-status.conflict {
      background: rgba(255, 68, 68, 0.2);
      color: #ff4444;
    }

    .report-input-group {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .report-input-group input {
      width: 40px;
      text-align: center;
      padding: 6px;
      font-size: 1rem;
      background: var(--b365-body-bg);
      border: 1px solid var(--b365-border);
      color: var(--b365-text-white);
      border-radius: 4px;
    }

    .report-input-group span {
      font-weight: bold;
      color: var(--b365-text-gray);
    }

    .report-btn {
      background: var(--b365-dark-green);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: bold;
      transition: all 0.2s;
    }

    .report-btn:hover {
      background: var(--b365-bright-green);
      color: #000;
    }

    .report-btn:disabled {
      background: #555;
      color: #888;
      cursor: not-allowed;
    }

    .your-report {
      font-size: 0.8rem;
      color: var(--b365-accent-yellow);
      margin-top: 4px;
    }

    .opponent-report {
      font-size: 0.8rem;
      color: #888;
      margin-top: 2px;
    }

    .admin-self-reports {
      font-size: 0.75rem;
      margin-top: 5px;
      padding: 5px 8px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }

    .admin-self-reports .report-item {
      display: inline-block;
      margin-right: 10px;
    }

    .admin-self-reports .reported {
      color: var(--b365-accent-yellow);
    }

    .admin-self-reports .waiting {
      color: #666;
    }

    /* Bet Slip Styles */
    .bet-slip-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 380px;
      background: linear-gradient(145deg, rgba(40, 40, 40, 0.98), rgba(30, 30, 30, 0.98));
      backdrop-filter: blur(10px);
      border: 1px solid rgba(18, 237, 128, 0.3);
      border-radius: 16px;
      padding: 0;
      display: none;
      z-index: 999;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(18, 237, 128, 0.1);
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      max-height: 80vh;
      flex-direction: column;
    }

    /* Flex display override when shown */
    .bet-slip-container.show {
      display: flex !important;
    }

    .bet-slip-header {
      background: linear-gradient(135deg, var(--b365-dark-green) 0%, #0a5a45 100%);
      padding: 18px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid var(--b365-bright-green);
      cursor: pointer;
      flex-shrink: 0;
    }

    .bet-slip-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .bet-slip-title h3 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #fff;
    }

    .bet-slip-badge {
      background: var(--b365-accent-yellow);
      color: #000;
      font-weight: bold;
      font-size: 0.85rem;
      padding: 4px 12px;
      border-radius: 20px;
    }

    .bet-slip-toggle-icon {
      margin-left: 10px;
      transition: transform 0.3s;
      font-size: 0.8rem;
    }

    .bet-slip-body {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .bet-slip-items-container {
      padding: 15px 20px;
      max-height: 300px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.2);
    }

    .bet-slip-stake-section {
      padding: 15px 20px;
      background: rgba(0, 0, 0, 0.15);
      flex-shrink: 0;
    }

    .bet-slip-input-wrapper {
      position: relative;
    }

    .bet-slip-input {
      width: 100%;
      padding: 14px 18px;
      padding-left: 35px;
      font-size: 1.1rem;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid var(--b365-border);
      border-radius: 10px;
      color: #fff;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .bet-slip-input:focus {
      border-color: var(--b365-bright-green);
      box-shadow: 0 0 0 3px rgba(18, 237, 128, 0.15);
    }

    .bet-slip-currency-symbol {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--b365-accent-yellow);
      font-weight: bold;
    }

    .bet-slip-potential {
      padding: 12px 20px;
      background: rgba(18, 237, 128, 0.1);
      border-top: 1px solid rgba(18, 237, 128, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .bet-slip-actions {
      padding: 15px 20px;
      padding-top: 0;
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-shrink: 0;
    }

    /* Minimized State */
    .bet-slip-container.minimized {
      width: auto !important;
      min-width: 200px;
      height: auto;
      border-radius: 30px;
      right: 20px;
      bottom: 20px;
    }

    .bet-slip-container.minimized .bet-slip-body {
      display: none;
    }

    .bet-slip-container.minimized .bet-slip-header {
      border-bottom: none;
      padding: 12px 20px;
      border-radius: 30px;
    }

    .bet-slip-container.minimized .bet-slip-toggle-icon {
      transform: rotate(180deg);
    }

    /* Mobile Styles */
    @media (max-width: 768px) {
      .bet-slip-container {
        width: calc(100% - 30px);
        right: 15px;
        left: 15px;
        bottom: 15px;
        max-height: 85vh;
      }

      .bet-slip-container.minimized {
        width: auto !important; /* Allow shrinking */
        left: auto; /* Unset left */
        right: 15px; /* Stick to right */
        bottom: 15px; /* Keep at bottom */
      }
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>

<body>

  <header>
    <div
      style="font-weight: 900; font-size: 1.6rem; color: var(--b365-bright-green); letter-spacing: -1px; display:flex; align-items:center; gap:10px;">
      bet365
      <button onclick="toggleTheme()"
        style="background:transparent; border:1px solid var(--b365-text-gray); color:var(--b365-text-gray); border-radius:50%; width:30px; height:30px; cursor:pointer; font-size:12px; display:flex; align-items:center; justify-content:center;"
        title="Toggle Light/Dark Mode">
        üåó
      </button>
    </div>
    <div style="display:flex; align-items:center; gap:20px;">
      <span id="headerUser" style="color:var(--b365-text-gray); font-size:0.9rem;"></span>

      <!-- Header Icon Group -->
      <div style="display:flex; align-items:center; gap:8px;">

        <!-- Notification Bell -->
        <div id="notification-container" style="position:relative; display:none;">
          <button class="notification-bell" onclick="toggleNotificationDropdown()" title="Notifications" style="
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
          ">
            üîî
            <span id="notification-badge" class="notification-badge hidden">0</span>
          </button>
          <div id="notification-dropdown" class="notification-dropdown">
            <div class="notification-dropdown-header">
              <span>üîî Notifications</span>
              <button onclick="clearAllNotifications()"
                style="background:transparent; border:none; color:#ccc; cursor:pointer; font-size:0.75rem;">
                Clear All
              </button>
            </div>
            <div id="notification-list" class="notification-list">
              <div class="notification-empty">No notifications</div>
            </div>
          </div>
        </div>

        <!-- Bet Cart -->
        <div id="cart-container" style="position:relative; display:none;">
          <button class="notification-bell" onclick="toggleCartDropdown()" title="Saved Bet Slips" style="
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: linear-gradient(145deg, rgba(107, 70, 193, 0.3), rgba(107, 70, 193, 0.15));
            border: 1px solid rgba(107, 70, 193, 0.4);
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
          ">
            üõí
            <span id="cart-badge" class="notification-badge hidden" style="background: #6B46C1;">0</span>
          </button>
          <div id="cart-dropdown" class="notification-dropdown" style="width:380px;">
            <div class="notification-dropdown-header"
              style="background:linear-gradient(135deg, #6B46C1 0%, #553C9A 100%);">
              <span>üõí Saved Bet Slips</span>
              <button onclick="clearAllCartSlips()"
                style="background:transparent; border:none; color:#ccc; cursor:pointer; font-size:0.75rem;">
                Clear All
              </button>
            </div>
            <div id="cart-list" style="max-height:400px; overflow-y:auto;">
              <div class="notification-empty">No saved slips</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Divider -->
      <div style="width:1px; height:28px; background:rgba(255,255,255,0.15);"></div>

      <button class="refresh-btn" onclick="logout()" style="
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      ">LOGOUT</button>
    </div>
  </header>

  <div id="login-screen" style="
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: calc(100vh - 70px);
    padding: 20px;
  ">
    <div class="card" style="
      background: linear-gradient(145deg, #1a2744 0%, #0f172a 100%);
      border: 2px solid var(--b365-bright-green);
      border-radius: 16px;
      overflow: hidden;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    ">
      <div class="card-header" style="
        background: linear-gradient(135deg, var(--b365-dark-green) 0%, #0a5a45 100%);
        padding: 25px;
        text-align: center;
        border-bottom: 2px solid var(--b365-bright-green);
      ">
        <div style="font-size: 2.5rem; margin-bottom: 10px;">üé∞</div>
        <div style="font-weight: 700; font-size: 1.3rem; text-transform: uppercase; letter-spacing: 2px; color: #fff;">
          Member Login
        </div>
        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-top: 5px;">Enter your credentials to
          continue</div>
      </div>
      <div class="card-body" style="padding: 30px;">
        <div style="margin-bottom: 20px;">
          <label
            style="font-size: 0.75rem; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 8px;">Username</label>
          <input id="userIn" placeholder="Enter username" onkeydown="if(event.key==='Enter') handleLogin()" style="
            width: 100%;
            padding: 14px 16px;
            background: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            transition: border-color 0.2s;
          " onfocus="this.style.borderColor='var(--b365-bright-green)'"
            onblur="this.style.borderColor='rgba(255,255,255,0.1)'" />
        </div>
        <div style="margin-bottom: 25px;">
          <label
            style="font-size: 0.75rem; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 8px;">Password</label>
          <input id="passIn" placeholder="Enter password" type="password"
            onkeydown="if(event.key==='Enter') handleLogin()" style="
            width: 100%;
            padding: 14px 16px;
            background: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            transition: border-color 0.2s;
          " onfocus="this.style.borderColor='var(--b365-bright-green)'"
            onblur="this.style.borderColor='rgba(255,255,255,0.1)'" />
        </div>
        <button onclick="handleLogin()" style="
          width: 100%;
          padding: 16px;
          background: linear-gradient(135deg, var(--b365-bright-green) 0%, #0fa968 100%);
          border: none;
          border-radius: 10px;
          color: #000;
          font-weight: bold;
          font-size: 1.1rem;
          cursor: pointer;
          transition: all 0.2s;
          text-transform: uppercase;
          letter-spacing: 1px;
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(18, 237, 128, 0.4)';"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
          üîê Sign In
        </button>
      </div>
    </div>
  </div>

  <!-- Custom Modal -->
  <!-- Generic Confirm Modal -->
  <div id="confirm-modal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center;">
    <div
      style="background:#333; padding:20px; border-radius:4px; max-width:300px; text-align:center; border:1px solid #555;">
      <h3 id="confirm-title" style="margin-top:0; color:#fff;">Confirm</h3>
      <p id="confirm-msg" style="color:#ccc; font-size:0.9rem;">Are you sure?</p>
      <div style="display:flex; gap:10px; justify-content:center; margin-top:15px;">
        <button class="refresh-btn" style="background:#555;" onclick="closeConfirmModal()">Cancel</button>
        <button id="confirm-btn-action" class="delete-btn">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Generic Input Modal -->
  <div id="prompt-modal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center;">
    <div
      style="background:#333; padding:20px; border-radius:4px; max-width:300px; text-align:center; border:1px solid #555;">
      <h3 id="prompt-title" style="margin-top:0; color:#fff;">Input</h3>
      <p id="prompt-msg" style="color:#ccc; font-size:0.9rem;">Enter value:</p>
      <input id="prompt-input"
        style="width:100%; margin:10px 0; padding:8px; background:#222; border:1px solid #555; color:#fff;" />
      <div style="display:flex; gap:10px; justify-content:center; margin-top:5px;">
        <button class="refresh-btn" style="background:#555;" onclick="closePromptModal()">Cancel</button>
        <button id="prompt-btn-action" class="action-btn" style="margin-top:0; width:auto;">OK</button>
      </div>
    </div>
  </div>

  <!-- Score Setting Modal -->
  <div id="score-modal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center;">
    <div
      style="background:#333; padding:25px; border-radius:8px; max-width:400px; width:90%; text-align:center; border:1px solid #555;">
      <h3 id="score-modal-title" style="margin-top:0; color:var(--b365-bright-green); font-size:1.1rem;">Set Match Score
      </h3>
      <div style="display:flex; align-items:center; justify-content:center; gap:15px; margin:20px 0;">
        <div style="text-align:right; flex:1;">
          <div id="score-home-name" style="font-weight:bold; color:#fff; margin-bottom:8px;">Home Team</div>
          <input type="number" id="score-home-input" min="0" max="99" value="0"
            style="width:60px; text-align:center; padding:12px; font-size:1.5rem; background:#222; border:2px solid var(--b365-dark-green); color:#fff; border-radius:6px;" />
        </div>
        <div style="font-size:1.5rem; font-weight:bold; color:#888;">-</div>
        <div style="text-align:left; flex:1;">
          <div id="score-away-name" style="font-weight:bold; color:#fff; margin-bottom:8px;">Away Team</div>
          <input type="number" id="score-away-input" min="0" max="99" value="0"
            style="width:60px; text-align:center; padding:12px; font-size:1.5rem; background:#222; border:2px solid var(--b365-dark-green); color:#fff; border-radius:6px;" />
        </div>
      </div>
      <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
        <button class="refresh-btn" style="background:#555; padding:10px 25px;"
          onclick="closeScoreModal()">Cancel</button>
        <button class="action-btn" style="margin-top:0; width:auto; padding:10px 25px;" onclick="confirmSetScore()">Set
          Score</button>
      </div>
    </div>
  </div>

  <div id="app" style="display:none">

    <div id="admin-tabs" class="tab-bar" style="display:none">
      <div class="tab-item active" onclick="switchTab('tab-matches', this)">‚öΩ Matches</div>
      <div class="tab-item" onclick="switchTab('tab-bets', this)">üé≤ Active Bets</div>
      <div class="tab-item" onclick="switchTab('tab-outright', this)">üèÜ Outright</div>
      <div class="tab-item" onclick="switchTab('tab-teams', this)">üë• Team Admin</div>
      <div class="tab-item" onclick="switchTab('tab-users', this)">üë§ Users</div>
      <div class="tab-item" onclick="switchTab('tab-analytics', this)">üìà Analytics</div>
    </div>

    <div class="container">

      <div id="admin-content" style="display:none">

        <div id="tab-matches" class="tab-pane">

          <!-- Auto-Generators Card -->
          <div class="card" style="
            background: linear-gradient(145deg, #1a2f1a 0%, #0d1f0d 100%);
            border: 2px solid var(--b365-bright-green);
            border-radius: 12px;
            overflow: hidden;
          ">
            <div class="card-header" style="
              background: linear-gradient(135deg, #166534 0%, #14532d 100%);
              padding: 16px 20px;
              display: flex;
              align-items: center;
              gap: 12px;
              border-bottom: 2px solid var(--b365-bright-green);
            ">
              <span style="font-size: 1.3rem;">‚ö°</span>
              <div>
                <div
                  style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: #fff;">
                  Auto-Generators</div>
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 2px;">Bulk create group stage
                  matches (Skipping Group E)</div>
              </div>
            </div>
            <div class="card-body" style="padding: 20px;">
              <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button onclick="generateGroupMatches(1)" style="
                  flex: 1;
                  min-width: 180px;
                  padding: 14px 20px;
                  background: linear-gradient(135deg, var(--b365-bright-green) 0%, #0fa968 100%);
                  border: none;
                  border-radius: 10px;
                  color: #000;
                  font-weight: bold;
                  font-size: 0.9rem;
                  cursor: pointer;
                  transition: all 0.2s;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 10px;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(18, 237, 128, 0.4)';"
                  onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                  <span style="font-size: 1.2rem;">üîÑ</span>
                  Generate 1-Leg Matches
                </button>
                <button onclick="generateGroupMatches(2)" style="
                  flex: 1;
                  min-width: 180px;
                  padding: 14px 20px;
                  background: linear-gradient(135deg, #ffffff 0%, #e5e5e5 100%);
                  border: 2px solid var(--b365-bright-green);
                  border-radius: 10px;
                  color: #000;
                  font-weight: bold;
                  font-size: 0.9rem;
                  cursor: pointer;
                  transition: all 0.2s;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 10px;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 0, 0, 0.2)';"
                  onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                  <span style="font-size: 1.2rem;">üîÅ</span>
                  Generate 2-Leg Matches
                </button>
              </div>
            </div>
          </div>

          <div class="card" style="
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid var(--b365-dark-green);
            border-radius: 12px;
            overflow: hidden;
          ">
            <div class="card-header" style="
              background: linear-gradient(135deg, var(--b365-dark-green) 0%, #0a5a45 100%);
              padding: 16px 20px;
              display: flex;
              align-items: center;
              gap: 12px;
              border-bottom: 2px solid var(--b365-bright-green);
            ">
              <span style="font-size: 1.5rem;">üèÜ</span>
              <div>
                <div
                  style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: #fff;">
                  Tournament Bracket</div>
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 2px;">Configure
                  Quarter-Finals, Semi-Finals & Finals</div>
              </div>
            </div>
            <div class="card-body" style="padding: 24px;">

              <!-- Playoff Configuration Panel -->
              <div style="
                background: linear-gradient(145deg, rgba(56, 56, 56, 0.6), rgba(40, 40, 40, 0.6));
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 20px;
              ">
                <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start;">

                  <!-- Stage Type -->
                  <div style="min-width: 140px;">
                    <label style="
                      font-size: 0.7rem; 
                      color: rgba(255,255,255,0.7); 
                      text-transform: uppercase; 
                      letter-spacing: 1px;
                      display: block;
                      margin-bottom: 8px;
                    ">Stage Type</label>
                    <select id="stageType" onchange="updateBracketStageUI()" style="
                      margin: 0; 
                      padding: 10px 15px; 
                      width: 100%;
                      background: rgba(0,0,0,0.3);
                      border: 1px solid rgba(255,255,255,0.2);
                      border-radius: 8px;
                      color: #fff;
                      font-weight: 600;
                    ">
                      <option value="SF">Semi-Finals</option>
                      <option value="QF">Quarter-Finals</option>
                    </select>
                  </div>

                  <!-- Leg Structure -->
                  <div style="min-width: 120px;">
                    <label style="
                      font-size: 0.7rem; 
                      color: rgba(255,255,255,0.7); 
                      text-transform: uppercase; 
                      letter-spacing: 1px;
                      display: block;
                      margin-bottom: 8px;
                    ">Leg Structure</label>
                    <select id="sfType" style="
                      margin: 0; 
                      padding: 10px 15px; 
                      width: 100%;
                      background: rgba(0,0,0,0.3);
                      border: 1px solid rgba(255,255,255,0.2);
                      border-radius: 8px;
                      color: #fff;
                      font-weight: 600;
                    ">
                      <option value="1">1 Leg</option>
                      <option value="2">2 Legs</option>
                    </select>
                    <div style="font-size: 0.65rem; color: rgba(255,255,255,0.4); margin-top: 4px;">Final is always 1
                      leg</div>
                  </div>

                  <!-- Divider -->
                  <div
                    style="width: 1px; height: 80px; background: linear-gradient(180deg, transparent, rgba(18,237,128,0.3), transparent); align-self: center;">
                  </div>

                  <!-- Match Pairings Container -->
                  <div id="bracket-pairings-container" style="flex: 1; display: flex; flex-wrap: wrap; gap: 15px;">

                    <!-- Semi-Final 1 -->
                    <div class="sf-pairing" style="flex: 1; min-width: 200px;">
                      <label style="
                        font-size: 0.7rem; 
                        color: var(--b365-accent-yellow); 
                        text-transform: uppercase; 
                        letter-spacing: 1px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        margin-bottom: 8px;
                      ">
                        <span
                          style="background: var(--b365-accent-yellow); color: #000; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: bold;">SF1</span>
                        Semi-Final 1
                      </label>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <select id="brSF1H" style="
                          flex: 1;
                          padding: 10px;
                          background: rgba(0,0,0,0.3);
                          border: 1px solid rgba(255,255,255,0.2);
                          border-radius: 8px;
                          color: #fff;
                        "></select>
                        <span style="
                          color: #fff; 
                          font-weight: bold; 
                          font-size: 0.9rem;
                          padding: 0 8px;
                        ">VS</span>
                        <select id="brSF1A" style="
                          flex: 1;
                          padding: 10px;
                          background: rgba(0,0,0,0.3);
                          border: 1px solid rgba(255,255,255,0.2);
                          border-radius: 8px;
                          color: #fff;
                        "></select>
                      </div>
                    </div>

                    <!-- Semi-Final 2 -->
                    <div class="sf-pairing" style="flex: 1; min-width: 200px;">
                      <label style="
                        font-size: 0.7rem; 
                        color: var(--b365-accent-yellow); 
                        text-transform: uppercase; 
                        letter-spacing: 1px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        margin-bottom: 8px;
                      ">
                        <span
                          style="background: var(--b365-accent-yellow); color: #000; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: bold;">SF2</span>
                        Semi-Final 2
                      </label>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <select id="brSF2H" style="
                          flex: 1;
                          padding: 10px;
                          background: rgba(0,0,0,0.3);
                          border: 1px solid rgba(255,255,255,0.2);
                          border-radius: 8px;
                          color: #fff;
                        "></select>
                        <span style="
                          color: #fff; 
                          font-weight: bold; 
                          font-size: 0.9rem;
                          padding: 0 8px;
                        ">VS</span>
                        <select id="brSF2A" style="
                          flex: 1;
                          padding: 10px;
                          background: rgba(0,0,0,0.3);
                          border: 1px solid rgba(255,255,255,0.2);
                          border-radius: 8px;
                          color: #fff;
                        "></select>
                      </div>
                    </div>

                    <!-- Quarter-Final 1 (hidden by default) -->
                    <div class="qf-pairing" style="flex: 1; min-width: 200px; display: none;">
                      <label style="
                        font-size: 0.7rem; 
                        color: #60a5fa; 
                        text-transform: uppercase; 
                        letter-spacing: 1px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        margin-bottom: 8px;
                      ">
                        <span
                          style="background: #3b82f6; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: bold;">QF1</span>
                        Quarter-Final 1
                      </label>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <select id="brQF1H" style="
                          flex: 1;
                          padding: 10px;
                          background: rgba(0,0,0,0.3);
                          border: 1px solid rgba(255,255,255,0.2);
                          border-radius: 8px;
                          color: #fff;
                        "></select>
                        <span style="color: #fff; font-weight: bold; font-size: 0.9rem; padding: 0 8px;">VS</span>
                        <select id="brQF1A" style="
                          flex: 1;
                          padding: 10px;
                          background: rgba(0,0,0,0.3);
                          border: 1px solid rgba(255,255,255,0.2);
                          border-radius: 8px;
                          color: #fff;
                        "></select>
                      </div>
                    </div>

                    <!-- Quarter-Final 2 (hidden by default) -->
                    <div class="qf-pairing" style="flex: 1; min-width: 200px; display: none;">
                      <label style="
                        font-size: 0.7rem; 
                        color: #60a5fa; 
                        text-transform: uppercase; 
                        letter-spacing: 1px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        margin-bottom: 8px;
                      ">
                        <span
                          style="background: #3b82f6; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: bold;">QF2</span>
                        Quarter-Final 2
                      </label>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <select id="brQF2H" style="
                          flex: 1;
                          padding: 10px;
                          background: rgba(0,0,0,0.3);
                          border: 1px solid rgba(255,255,255,0.2);
                          border-radius: 8px;
                          color: #fff;
                        "></select>
                        <span style="color: #fff; font-weight: bold; font-size: 0.9rem; padding: 0 8px;">VS</span>
                        <select id="brQF2A" style="
                          flex: 1;
                          padding: 10px;
                          background: rgba(0,0,0,0.3);
                          border: 1px solid rgba(255,255,255,0.2);
                          border-radius: 8px;
                          color: #fff;
                        "></select>
                      </div>
                    </div>

                    <!-- Quarter-Final 3 (hidden by default) -->
                    <div class="qf-pairing" style="flex: 1; min-width: 200px; display: none;">
                      <label style="
                        font-size: 0.7rem; 
                        color: #60a5fa; 
                        text-transform: uppercase; 
                        letter-spacing: 1px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        margin-bottom: 8px;
                      ">
                        <span
                          style="background: #3b82f6; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: bold;">QF3</span>
                        Quarter-Final 3
                      </label>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <select id="brQF3H" style="
                          flex: 1;
                          padding: 10px;
                          background: rgba(0,0,0,0.3);
                          border: 1px solid rgba(255,255,255,0.2);
                          border-radius: 8px;
                          color: #fff;
                        "></select>
                        <span style="color: #fff; font-weight: bold; font-size: 0.9rem; padding: 0 8px;">VS</span>
                        <select id="brQF3A" style="
                          flex: 1;
                          padding: 10px;
                          background: rgba(0,0,0,0.3);
                          border: 1px solid rgba(255,255,255,0.2);
                          border-radius: 8px;
                          color: #fff;
                        "></select>
                      </div>
                    </div>

                    <!-- Quarter-Final 4 (hidden by default) -->
                    <div class="qf-pairing" style="flex: 1; min-width: 200px; display: none;">
                      <label style="
                        font-size: 0.7rem; 
                        color: #60a5fa; 
                        text-transform: uppercase; 
                        letter-spacing: 1px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        margin-bottom: 8px;
                      ">
                        <span
                          style="background: #3b82f6; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: bold;">QF4</span>
                        Quarter-Final 4
                      </label>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <select id="brQF4H" style="
                          flex: 1;
                          padding: 10px;
                          background: rgba(0,0,0,0.3);
                          border: 1px solid rgba(255,255,255,0.2);
                          border-radius: 8px;
                          color: #fff;
                        "></select>
                        <span style="color: #fff; font-weight: bold; font-size: 0.9rem; padding: 0 8px;">VS</span>
                        <select id="brQF4A" style="
                          flex: 1;
                          padding: 10px;
                          background: rgba(0,0,0,0.3);
                          border: 1px solid rgba(255,255,255,0.2);
                          border-radius: 8px;
                          color: #fff;
                        "></select>
                      </div>
                    </div>

                  </div>

                  <!-- Start Button -->
                  <div style="display: flex; align-items: flex-end;">
                    <button onclick="initBracket()" style="
                      background: linear-gradient(135deg, var(--b365-bright-green) 0%, #0fa968 100%);
                      color: #000;
                      border: none;
                      padding: 12px 24px;
                      border-radius: 8px;
                      font-weight: bold;
                      font-size: 0.9rem;
                      cursor: pointer;
                      transition: all 0.2s;
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(18, 237, 128, 0.4)';"
                      onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                      üöÄ Start Playoffs
                    </button>
                  </div>
                </div>
              </div>

              <div class="bracket-container" id="bracket-display">
                <div class="bracket-empty">
                  <div style="font-size:3rem; margin-bottom:15px; opacity:0.3;">üèÜ</div>
                  <div style="font-size:1.1rem; color:#888;">Tournament bracket not initialized</div>
                  <div style="font-size:0.85rem; color:#666; margin-top:8px;">Select semi-finalists above to begin</div>
                </div>
              </div>
            </div>
          </div>

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">

            <!-- Manual Match Init Card -->
            <div class="card" style="
              background: linear-gradient(145deg, #2d1f3d 0%, #1a1a2e 100%);
              border: 2px solid rgba(107, 70, 193, 0.4);
              border-radius: 12px;
              overflow: hidden;
            ">
              <div class="card-header" style="
                background: linear-gradient(135deg, #6B46C1 0%, #553C9A 100%);
                padding: 16px 20px;
                display: flex;
                align-items: center;
                gap: 12px;
                border-bottom: 2px solid rgba(107, 70, 193, 0.6);
              ">
                <span style="font-size: 1.3rem;">‚öΩ</span>
                <div>
                  <div
                    style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: #fff;">
                    Create
                    Match</div>
                  <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 2px;">Ad-hoc / Friendly
                    Games</div>
                </div>
              </div>
              <div class="card-body" style="padding: 24px;">

                <!-- Team Selection -->
                <div style="
                  background: rgba(0,0,0,0.2);
                  border-radius: 12px;
                  padding: 20px;
                  margin-bottom: 16px;
                ">
                  <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="flex: 1;">
                      <label style="
                        font-size: 0.7rem; 
                        color: rgba(255,255,255,0.7); 
                        text-transform: uppercase; 
                        letter-spacing: 1px;
                        display: block;
                        margin-bottom: 8px;
                      ">Home Team</label>
                      <select id="gmHome" style="
                        width: 100%;
                        padding: 12px;
                        background: rgba(0,0,0,0.3);
                        border: 1px solid rgba(255,255,255,0.2);
                        border-radius: 8px;
                        color: #fff;
                        font-weight: 600;
                      "></select>
                    </div>

                    <div style="
                      display: flex;
                      flex-direction: column;
                      align-items: center;
                      padding: 0 10px;
                    ">
                      <span style="
                        background: linear-gradient(135deg, #6B46C1, #553C9A);
                        color: white;
                        padding: 8px 16px;
                        border-radius: 20px;
                        font-weight: bold;
                        font-size: 0.9rem;
                      ">VS</span>
                    </div>

                    <div style="flex: 1;">
                      <label style="
                        font-size: 0.7rem; 
                        color: rgba(255,255,255,0.7); 
                        text-transform: uppercase; 
                        letter-spacing: 1px;
                        display: block;
                        margin-bottom: 8px;
                      ">Away Team</label>
                      <select id="gmAway" style="
                        width: 100%;
                        padding: 12px;
                        background: rgba(0,0,0,0.3);
                        border: 1px solid rgba(255,255,255,0.2);
                        border-radius: 8px;
                        color: #fff;
                        font-weight: 600;
                      "></select>
                    </div>
                  </div>
                </div>

                <!-- Suggest Odds Button -->
                <button class="ghost-btn" onclick="suggestOddsDOM()" style="
                  width: 100%;
                  padding: 12px;
                  background: transparent;
                  border: 2px dashed rgba(107, 70, 193, 0.5);
                  border-radius: 8px;
                  color: #9f7aea;
                  font-weight: 600;
                  cursor: pointer;
                  transition: all 0.2s;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 8px;
                " onmouseover="this.style.borderColor='#9f7aea'; this.style.background='rgba(107, 70, 193, 0.1)';"
                  onmouseout="this.style.borderColor='rgba(107, 70, 193, 0.5)'; this.style.background='transparent';">
                  üí° Auto-Suggest Odds from Team Strength
                </button>

                <!-- Odds Input Grid -->
                <div style="
                  display: grid; 
                  grid-template-columns: 1fr 1fr 1fr; 
                  gap: 12px; 
                  margin-top: 16px;
                ">
                  <div>
                    <label
                      style="font-size: 0.65rem; color: #888; text-transform: uppercase; display: block; margin-bottom: 6px; text-align: center;">Home
                      Win</label>
                    <input id="o1" placeholder="1.00" style="
                      width: 100%;
                      padding: 12px;
                      text-align: center;
                      background: rgba(0,0,0,0.3);
                      border: 1px solid rgba(255,255,255,0.2);
                      border-radius: 8px;
                      color: var(--b365-accent-yellow);
                      font-weight: bold;
                      font-size: 1.1rem;
                    " />
                  </div>
                  <div>
                    <label
                      style="font-size: 0.65rem; color: #888; text-transform: uppercase; display: block; margin-bottom: 6px; text-align: center;">Draw</label>
                    <input id="oX" placeholder="1.00" style="
                      width: 100%;
                      padding: 12px;
                      text-align: center;
                      background: rgba(0,0,0,0.3);
                      border: 1px solid rgba(255,255,255,0.2);
                      border-radius: 8px;
                      color: var(--b365-accent-yellow);
                      font-weight: bold;
                      font-size: 1.1rem;
                    " />
                  </div>
                  <div>
                    <label
                      style="font-size: 0.65rem; color: #888; text-transform: uppercase; display: block; margin-bottom: 6px; text-align: center;">Away
                      Win</label>
                    <input id="o2" placeholder="1.00" style="
                      width: 100%;
                      padding: 12px;
                      text-align: center;
                      background: rgba(0,0,0,0.3);
                      border: 1px solid rgba(255,255,255,0.2);
                      border-radius: 8px;
                      color: var(--b365-accent-yellow);
                      font-weight: bold;
                      font-size: 1.1rem;
                    " />
                  </div>
                </div>

                <!-- Post Match Button -->
                <button onclick="createMatch()" style="
                  width: 100%;
                  margin-top: 20px;
                  padding: 14px;
                  background: linear-gradient(135deg, #6B46C1 0%, #553C9A 100%);
                  border: none;
                  border-radius: 8px;
                  color: white;
                  font-weight: bold;
                  font-size: 0.95rem;
                  cursor: pointer;
                  transition: all 0.2s;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 8px;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(107, 70, 193, 0.4)';"
                  onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                  ‚öΩ Create Match
                </button>
              </div>
            </div>

            <!-- Open Settlements Card -->
            <div class="card" style="
              background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
              border: 2px solid rgba(239, 68, 68, 0.3);
              border-radius: 12px;
              overflow: hidden;
            ">
              <div class="card-header" style="
                background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
                padding: 16px 20px;
                display: flex;
                align-items: center;
                gap: 12px;
                border-bottom: 2px solid rgba(239, 68, 68, 0.6);
              ">
                <span style="font-size: 1.3rem;">üìã</span>
                <div>
                  <div
                    style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: #fff;">
                    Open
                    Settlements</div>
                  <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 2px;">Matches requiring
                    score input</div>
                </div>
              </div>
              <div id="admin-match-list" style="max-height: 450px; overflow-y: auto; padding: 10px;"></div>
            </div>
          </div>
        </div>

        <div id="tab-bets" class="tab-pane" style="display:none">
          <!-- Active Bets Card -->
          <div class="card" style="
            background: linear-gradient(145deg, #1a2744 0%, #0f172a 100%);
            border: 2px solid rgba(59, 130, 246, 0.4);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
          ">
            <div class="card-header" style="
              background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
              padding: 16px 20px;
              display: flex;
              align-items: center;
              gap: 12px;
              border-bottom: 2px solid rgba(59, 130, 246, 0.6);
            ">
              <span style="font-size: 1.3rem;">üé≤</span>
              <div>
                <div
                  style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: #fff;">
                  All
                  Active Bets</div>
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 2px;">Currently pending wagers
                </div>
              </div>
            </div>
            <div id="admin-active-bets" style="padding: 15px; max-height: 400px; overflow-y: auto;"></div>
          </div>

          <!-- Bet History Card -->
          <div class="card" style="
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            border: 2px solid rgba(156, 163, 175, 0.3);
            border-radius: 12px;
            overflow: hidden;
          ">
            <div class="card-header" style="
              background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
              padding: 16px 20px;
              display: flex;
              align-items: center;
              gap: 12px;
              border-bottom: 2px solid rgba(156, 163, 175, 0.4);
            ">
              <span style="font-size: 1.3rem;">üìú</span>
              <div>
                <div
                  style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: #fff;">
                  Bet
                  History</div>
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 2px;">Settled wagers and
                  outcomes</div>
              </div>
            </div>
            <div id="admin-bet-history" style="padding: 15px; max-height: 500px; overflow-y: auto;"></div>
          </div>
        </div>

        <!-- Outright Winner Admin Tab -->
        <div id="tab-outright" class="tab-pane" style="display:none">
          <div class="card outright-card">
            <div class="outright-header">
              <span class="trophy-icon">üèÜ</span>
              <h3>Tournament Winner Market</h3>
              <span id="outright-market-status" class="status-badge closed">CLOSED</span>
            </div>
            <div class="card-body">
              <div
                style="display:flex; gap:15px; margin-bottom:20px; align-items:center; background:#333; padding:15px; border-radius:8px;">
                <div>
                  <label style="font-size:0.75rem; color:#888;">Market Status</label>
                  <div style="display:flex; gap:10px; margin-top:5px;">
                    <button class="action-btn" style="margin:0; width:auto; padding:8px 20px;"
                      onclick="toggleOutrightMarket(true)">Open Market</button>
                    <button class="ghost-btn" style="margin:0; width:auto; padding:8px 20px;"
                      onclick="toggleOutrightMarket(false)">Close Market</button>
                  </div>
                </div>
                <div style="border-left:1px solid #555; padding-left:15px;">
                  <label style="font-size:0.75rem; color:#888;">Quick Actions</label>
                  <div style="display:flex; gap:10px; margin-top:5px;">
                    <button class="refresh-btn" onclick="autoGenerateOutrightOdds()">üîÑ Auto-Generate Odds</button>
                    <button class="delete-btn" onclick="settleOutrightMarket()">‚ö° Settle Market</button>
                  </div>
                </div>
                <div style="border-left:1px solid #555; padding-left:15px;">
                  <label style="font-size:0.75rem; color:#888;">‚è∞ Auto-Close Timer</label>
                  <div style="display:flex; gap:10px; margin-top:5px; align-items:center;">
                    <input type="datetime-local" id="outright-close-time"
                      style="padding:6px; background:#222; border:1px solid #555; color:#fff; border-radius:4px;" />
                    <button class="action-btn" style="margin:0; width:auto; padding:6px 15px;"
                      onclick="setOutrightCloseTime()">Set Timer</button>
                    <button class="ghost-btn" style="margin:0; width:auto; padding:6px 15px;"
                      onclick="clearOutrightCloseTime()">Clear</button>
                  </div>
                  <div id="admin-close-time-display"
                    style="font-size:0.75rem; color:var(--b365-accent-yellow); margin-top:5px;"></div>
                </div>
              </div>

              <h4 style="color:var(--b365-text-gray); margin-bottom:10px; font-size:0.85rem;">SET TEAM ODDS</h4>
              <div id="admin-outright-teams"
                style="max-height:400px; overflow-y:auto; border:1px solid #444; border-radius:4px;">
                <!-- Team rows will be rendered here -->
              </div>

              <div class="card" style="margin-top:20px;">
                <div class="card-header">Active Outright Bets</div>
                <div id="admin-outright-bets"></div>
              </div>
            </div>
          </div>
        </div>

        <div id="tab-teams" class="tab-pane" style="display:none">
          <!-- Register New Team Card -->
          <div class="card" style="
            background: linear-gradient(145deg, #1e3a5f 0%, #0f2744 100%);
            border: 2px solid rgba(14, 165, 233, 0.4);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
          ">
            <div class="card-header" style="
              background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
              padding: 16px 20px;
              display: flex;
              align-items: center;
              gap: 12px;
              border-bottom: 2px solid rgba(14, 165, 233, 0.6);
            ">
              <span style="font-size: 1.3rem;">‚ûï</span>
              <div>
                <div
                  style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: #fff;">
                  Register
                  New Team</div>
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 2px;">Add a team to the
                  tournament</div>
              </div>
            </div>
            <div class="card-body" style="padding: 20px;">
              <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                <div style="flex: 2; min-width: 200px;">
                  <label
                    style="font-size: 0.7rem; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 8px;">Team
                    Name</label>
                  <input id="tName" placeholder="e.g. Liverpool" style="
                    width: 100%;
                    padding: 12px;
                    background: rgba(0,0,0,0.3);
                    border: 1px solid rgba(255,255,255,0.2);
                    border-radius: 8px;
                    color: #fff;
                    font-size: 1rem;
                  " />
                </div>
                <div style="flex: 1; min-width: 140px;">
                  <label
                    style="font-size: 0.7rem; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 8px;">Initial
                    Group</label>
                  <select id="tGroup" style="
                    width: 100%;
                    padding: 12px;
                    background: rgba(0,0,0,0.3);
                    border: 1px solid rgba(255,255,255,0.2);
                    border-radius: 8px;
                    color: #fff;
                    font-size: 1rem;
                  ">
                    <option value="A">Group A</option>
                    <option value="B">Group B</option>
                    <option value="C">Group C</option>
                    <option value="D">Group D</option>
                    <option value="E">Group E</option>
                  </select>
                </div>
                <button onclick="registerTeam()" style="
                  flex: 1;
                  min-width: 140px;
                  padding: 14px 20px;
                  background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
                  border: none;
                  border-radius: 8px;
                  color: white;
                  font-weight: bold;
                  font-size: 0.9rem;
                  cursor: pointer;
                  transition: all 0.2s;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 8px;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(14, 165, 233, 0.4)';"
                  onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                  ‚ûï Add Team
                </button>
              </div>
            </div>
          </div>

          <!-- Team Strength & Management Card -->
          <div class="card" style="
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            border: 2px solid rgba(251, 191, 36, 0.3);
            border-radius: 12px;
            overflow: hidden;
          ">
            <div class="card-header" style="
              background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
              padding: 16px 20px;
              display: flex;
              justify-content: space-between;
              align-items: center;
              border-bottom: 2px solid rgba(251, 191, 36, 0.6);
            ">
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 1.3rem;">üìä</span>
                <div>
                  <div
                    style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: #fff;">
                    Team
                    Strength & Groups</div>
                  <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 2px;">Manage form history
                    and coefficients</div>
                </div>
              </div>
              <button onclick="archiveTournament()" style="
                padding: 10px 16px;
                background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                border: none;
                border-radius: 6px;
                color: white;
                font-weight: bold;
                font-size: 0.8rem;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 6px;
              " onmouseover="this.style.transform='scale(1.02)';" onmouseout="this.style.transform='scale(1)';">
                üì¶ Archive Tournament
              </button>
            </div>
            <div style="overflow-x: auto; padding: 15px;">
              <table id="admin-teams-table" style="width: 100%; border-collapse: separate; border-spacing: 0;">
                <thead>
                  <tr style="background: rgba(0,0,0,0.3);">
                    <th style="padding: 12px 15px; text-align: left; border-bottom: 2px solid rgba(255,255,255,0.1);">
                      Team</th>
                    <th style="padding: 12px 15px; text-align: center; border-bottom: 2px solid rgba(255,255,255,0.1);">
                      Group</th>
                    <th style="padding: 12px 15px; text-align: center; border-bottom: 2px solid rgba(255,255,255,0.1);">
                      Form History</th>
                    <th style="padding: 12px 15px; text-align: center; border-bottom: 2px solid rgba(255,255,255,0.1);">
                      Strength</th>
                    <th style="padding: 12px 15px; text-align: center; border-bottom: 2px solid rgba(255,255,255,0.1);">
                      Actions</th>
                  </tr>
                </thead>
                <tbody id="admin-teams-body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="tab-users" class="tab-pane" style="display:none">
          <!-- Create New User Card -->
          <div class="card" style="
            background: linear-gradient(145deg, #2d1f3d 0%, #1a1a2e 100%);
            border: 2px solid rgba(168, 85, 247, 0.4);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
          ">
            <div class="card-header" style="
              background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%);
              padding: 16px 20px;
              display: flex;
              align-items: center;
              gap: 12px;
              border-bottom: 2px solid rgba(168, 85, 247, 0.6);
            ">
              <span style="font-size: 1.3rem;">üë§</span>
              <div>
                <div
                  style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: #fff;">
                  Create
                  New User</div>
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 2px;">Add a new betting
                  account</div>
              </div>
            </div>
            <div class="card-body" style="padding: 20px;">
              <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 150px;">
                  <label
                    style="font-size: 0.7rem; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 8px;">Username</label>
                  <input id="uName" placeholder="e.g. Player1" style="
                    width: 100%;
                    padding: 12px;
                    background: rgba(0,0,0,0.3);
                    border: 1px solid rgba(255,255,255,0.2);
                    border-radius: 8px;
                    color: #fff;
                    font-size: 1rem;
                  " />
                </div>
                <div style="flex: 1; min-width: 150px;">
                  <label
                    style="font-size: 0.7rem; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 8px;">Password</label>
                  <input id="uPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="
                    width: 100%;
                    padding: 12px;
                    background: rgba(0,0,0,0.3);
                    border: 1px solid rgba(255,255,255,0.2);
                    border-radius: 8px;
                    color: #fff;
                    font-size: 1rem;
                  " />
                </div>
                <div style="flex: 1; min-width: 120px;">
                  <label
                    style="font-size: 0.7rem; color: var(--b365-accent-yellow); text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 8px;">üí∞
                    Credits</label>
                  <input id="uCred" type="number" placeholder="1000" style="
                    width: 100%;
                    padding: 12px;
                    background: rgba(0,0,0,0.3);
                    border: 1px solid rgba(255,255,255,0.2);
                    border-radius: 8px;
                    color: var(--b365-accent-yellow);
                    font-size: 1rem;
                    font-weight: bold;
                  " />
                </div>
                <button onclick="createUser()" style="
                  flex: 1;
                  min-width: 140px;
                  padding: 14px 20px;
                  background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
                  border: none;
                  border-radius: 8px;
                  color: white;
                  font-weight: bold;
                  font-size: 0.9rem;
                  cursor: pointer;
                  transition: all 0.2s;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 8px;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(168, 85, 247, 0.4)';"
                  onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                  üë§ Add User
                </button>
              </div>
            </div>
          </div>

          <!-- Active Users Card -->
          <div class="card" style="
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            border: 2px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            overflow: hidden;
          ">
            <div class="card-header" style="
              background: linear-gradient(135deg, #059669 0%, #047857 100%);
              padding: 16px 20px;
              display: flex;
              align-items: center;
              gap: 12px;
              border-bottom: 2px solid rgba(16, 185, 129, 0.6);
            ">
              <span style="font-size: 1.3rem;">üë•</span>
              <div>
                <div
                  style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: #fff;">
                  Active
                  Users & Stats</div>
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 2px;">Manage credits and view
                  team statistics</div>
              </div>
            </div>
            <div id="user-list-admin" style="padding: 15px; max-height: 500px; overflow-y: auto;"></div>
          </div>
        </div>

        <div id="tab-analytics" class="tab-pane" style="display:none">
          <!-- Analytics Dashboard Card -->
          <div class="card" style="
            background: linear-gradient(145deg, #1a1a2e 0%, #0d1117 100%);
            border: 2px solid rgba(236, 72, 153, 0.3);
            border-radius: 12px;
            overflow: hidden;
          ">
            <div class="card-header" style="
              background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);
              padding: 16px 20px;
              display: flex;
              align-items: center;
              gap: 12px;
              border-bottom: 2px solid rgba(236, 72, 153, 0.6);
            ">
              <span style="font-size: 1.3rem;">üìà</span>
              <div>
                <div
                  style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: #fff;">
                  Bet
                  Analytics Dashboard</div>
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 2px;">Performance metrics and
                  insights</div>
              </div>
            </div>
            <div id="analytics-dashboard" style="padding: 20px;"></div>
          </div>
        </div>
      </div>

      <div id="user-content" style="display:none">
        <!-- User Welcome Card -->
        <div class="card" style="
          background: linear-gradient(145deg, #1a2744 0%, #0f172a 100%);
          border: 2px solid var(--b365-bright-green);
          border-radius: 12px;
          overflow: hidden;
          margin-bottom: 20px;
        ">
          <div style="
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
          ">
            <div style="display: flex; align-items: center; gap: 15px;">
              <div style="
                width: 50px;
                height: 50px;
                background: linear-gradient(135deg, var(--b365-bright-green) 0%, #0fa968 100%);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
              ">üë§</div>
              <div>
                <div style="font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 1px;">Welcome
                  back</div>
                <div style="font-size: 1.3rem; font-weight: 700;" id="display-name"></div>
              </div>
            </div>
            <div style="
              background: rgba(0,0,0,0.3);
              padding: 15px 25px;
              border-radius: 10px;
              border: 1px solid rgba(255,215,27,0.3);
              text-align: right;
            ">
              <div style="font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 1px;">Balance</div>
              <div style="font-size: 1.8rem; font-weight: 700; color: var(--b365-accent-yellow);">
                <span style="font-size: 1rem; opacity: 0.7;">$</span><span id="display-balance">0</span>
              </div>
            </div>
          </div>
        </div>

        <!-- User Tab Bar -->
        <div id="user-tabs" class="tab-bar">
          <div class="tab-item active" onclick="switchUserTab('user-tab-markets', this)">‚öΩ Markets</div>
          <div class="tab-item" onclick="switchUserTab('user-tab-my-matches', this)">üìã My Matches</div>
          <div class="tab-item" onclick="switchUserTab('user-tab-bets', this)">üé´ My Bets</div>
          <div class="tab-item" onclick="switchUserTab('user-tab-leaderboard', this)">üèÖ Leaderboard</div>
        </div>

        <!-- Markets Tab (Original Content) -->
        <div id="user-tab-markets" class="user-tab-pane">
          <!-- Outright Winner Betting Section for Users -->
          <div id="user-outright-section" class="card outright-card" style="display:none;">
            <div class="outright-header">
              <span class="trophy-icon">üèÜ</span>
              <h3>Tournament Winner</h3>
              <div style="margin-left:auto; display:flex; align-items:center; gap:10px;">
                <span id="user-outright-countdown"
                  style="font-size:0.85rem; color:var(--b365-accent-yellow); font-weight:bold;"></span>
                <span class="status-badge open">BETTING OPEN</span>
              </div>
            </div>
            <div class="outright-grid" id="user-outright-grid">
              <!-- Team cards rendered here -->
            </div>
            <div class="outright-bet-slip" id="outright-bet-slip" style="display:none;">
              <div class="selection">
                <div class="selection-label">Your Pick</div>
                <div class="selection-value" id="outright-pick-display">-</div>
              </div>
              <input type="number" id="outright-stake" placeholder="Stake" style="width:100px; margin:0;" />
              <button class="action-btn" style="margin:0; width:auto; padding:10px 25px;"
                onclick="placeOutrightBet()">Place Bet</button>
            </div>
            <div id="user-outright-existing"
              style="padding:15px; background:#2a2a2a; border-top:1px solid #444; display:none;">
              <div style="font-size:0.8rem; color:#888;">YOUR ACTIVE OUTRIGHT BET</div>
              <div id="user-outright-bet-info" style="margin-top:8px;"></div>
            </div>
          </div>

          <!-- Live & Upcoming Matches -->
          <div class="card" style="
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
          ">
            <div class="card-header" style="
              background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
              padding: 16px 20px;
              display: flex;
              align-items: center;
              gap: 12px;
              border-bottom: 2px solid rgba(59, 130, 246, 0.6);
            ">
              <span style="font-size: 1.3rem;">‚öΩ</span>
              <div>
                <div
                  style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: #fff;">
                  Live &
                  Upcoming</div>
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 2px;">Place your bets on
                  active matches</div>
              </div>
            </div>
            <div id="user-betting-odds" style="padding: 0;"></div>
          </div>

          <!-- User Bet History -->
          <div class="card" style="
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            border: 2px solid rgba(156, 163, 175, 0.3);
            border-radius: 12px;
            overflow: hidden;
          ">
            <div class="card-header" style="
              background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
              padding: 16px 20px;
              display: flex;
              align-items: center;
              gap: 12px;
              border-bottom: 2px solid rgba(156, 163, 175, 0.4);
            ">
              <span style="font-size: 1.3rem;">üìú</span>
              <div>
                <div
                  style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: #fff;">
                  Bet
                  History</div>
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 2px;">Your past betting
                  activity</div>
              </div>
            </div>
            <div id="user-bet-history" style="padding: 15px; max-height: 400px; overflow-y: auto;"></div>
          </div>
        </div>

        <!-- My Matches Tab (Self-Report) -->
        <div id="user-tab-my-matches" class="user-tab-pane" style="display:none;">
          <!-- Report Matches Card -->
          <div class="card" style="
            background: linear-gradient(145deg, #1e3a5f 0%, #0f2744 100%);
            border: 2px solid rgba(14, 165, 233, 0.4);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
          ">
            <div class="card-header" style="
              background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
              padding: 16px 20px;
              display: flex;
              justify-content: space-between;
              align-items: center;
              border-bottom: 2px solid rgba(14, 165, 233, 0.6);
            ">
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 1.3rem;">üìã</span>
                <div>
                  <div
                    style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: #fff;">
                    My
                    Matches</div>
                  <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 2px;">Report your match
                    results</div>
                </div>
              </div>
            </div>
            <div id="my-matches-list" style="padding: 0;"></div>
          </div>

          <!-- Self-Report Rules Card -->
          <div class="card" style="
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            border: 2px solid rgba(156, 163, 175, 0.2);
            border-radius: 12px;
            overflow: hidden;
          ">
            <div class="card-header" style="
              background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
              padding: 14px 20px;
              display: flex;
              align-items: center;
              gap: 10px;
            ">
              <span style="font-size: 1.1rem;">üìö</span>
              <span style="font-weight: 600;">Self-Report Rules</span>
            </div>
            <div class="card-body" style="padding: 20px; font-size: 0.9rem; color: #ccc; line-height: 1.8;">
              <ul style="margin: 0; padding-left: 20px;">
                <li>Only users whose username matches a team name can report scores</li>
                <li>If <strong style="color: var(--b365-bright-green);">both participants report the same
                    score</strong>, it will be automatically accepted</li>
                <li>If only one team reports, or scores don't match, <strong
                    style="color: var(--b365-accent-yellow);">admin approval is required</strong></li>
                <li>Already finalized matches cannot be re-reported</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- My Bets Tab -->
        <div id="user-tab-bets" class="user-tab-pane" style="display:none;">
          <!-- Outright Winner Bet Card -->
          <div class="card" style="
            background: linear-gradient(145deg, #2d2a1a 0%, #1a1810 100%);
            border: 2px solid rgba(251, 191, 36, 0.4);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
          ">
            <div class="card-header" style="
              background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
              padding: 16px 20px;
              display: flex;
              align-items: center;
              gap: 12px;
              border-bottom: 2px solid rgba(251, 191, 36, 0.6);
            ">
              <span style="font-size: 1.3rem;">üèÜ</span>
              <div>
                <div
                  style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: #fff;">
                  Outright
                  Winner Bet</div>
                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 2px;">Your tournament winner
                  prediction</div>
              </div>
            </div>
            <div id="user-active-outright-display" style="padding: 20px;"></div>
          </div>

          <!-- Active Bets & Parlays Card -->
          <div class="card" style="
            background: linear-gradient(145deg, #1a2744 0%, #0f172a 100%);
            border: 2px solid rgba(59, 130, 246, 0.4);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
          ">
            <div class="card-header" style="
              background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
              padding: 16px 20px;
              display: flex;
              justify-content: space-between;
              align-items: center;
              border-bottom: 2px solid rgba(59, 130, 246, 0.6);
            ">
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 1.3rem;">üé´</span>
                <div>
                  <div
                    style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: #fff;">
                    Active
                    Bets & Parlays</div>
                  <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 2px;">Your pending wagers
                  </div>
                </div>
              </div>
              <span id="active-bets-count" style="
                background: rgba(18, 237, 128, 0.2);
                color: var(--b365-bright-green);
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 0.8rem;
                font-weight: 600;
              "></span>
            </div>
            <div id="user-active-bets-list" style="padding: 15px;"></div>
            <div id="user-active-parlays-list" style="padding: 0 15px 15px 15px;"></div>
          </div>

          <!-- Resolved Bets Card -->
          <div class="card" style="
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            border: 2px solid rgba(156, 163, 175, 0.3);
            border-radius: 12px;
            overflow: hidden;
          ">
            <div class="card-header" style="
              background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
              padding: 16px 20px;
              display: flex;
              justify-content: space-between;
              align-items: center;
              border-bottom: 2px solid rgba(156, 163, 175, 0.4);
            ">
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 1.3rem;">‚úÖ</span>
                <div>
                  <div
                    style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: #fff;">
                    Resolved Bets</div>
                  <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 2px;">Settled wager outcomes
                  </div>
                </div>
              </div>
              <span id="resolved-bets-count" style="
                background: rgba(156, 163, 175, 0.2);
                color: #9ca3af;
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 0.8rem;
                font-weight: 600;
              "></span>
            </div>
            <div id="user-resolved-bets-list" style="padding: 15px; max-height: 400px; overflow-y: auto;"></div>
          </div>
        </div>

        <!-- Leaderboard Tab -->
        <div id="user-tab-leaderboard" class="user-tab-pane" style="display:none;">
          <div class="card" style="
            background: linear-gradient(145deg, #2d1f3d 0%, #1a1a2e 100%);
            border: 2px solid rgba(168, 85, 247, 0.4);
            border-radius: 12px;
            overflow: hidden;
          ">
            <div class="card-header" style="
              background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%);
              padding: 16px 20px;
              display: flex;
              justify-content: space-between;
              align-items: center;
              border-bottom: 2px solid rgba(168, 85, 247, 0.6);
            ">
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 1.3rem;">üèÖ</span>
                <div>
                  <div
                    style="font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: #fff;">
                    Leaderboard</div>
                  <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-top: 2px;">Rankings by credits
                  </div>
                </div>
              </div>
            </div>
            <div id="leaderboard-list" style="padding: 0;"></div>
          </div>
        </div>

        <div id="notifications" style="position:fixed; top:10px; right:10px; z-index:99;"></div>
      </div>

      <!-- Group Standings Section -->
      <div style="margin-top: 30px;">
        <div style="
          display: flex;
          align-items: center;
          gap: 12px;
          margin-bottom: 20px;
          padding: 0 10px;
        ">
          <span style="font-size: 1.5rem;">üìä</span>
          <div>
            <div
              style="font-weight: 700; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; color: #fff;">
              Group Standings</div>
            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.5);">Tournament group phase rankings</div>
          </div>
        </div>
        <div id="standings-area"
          style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;"></div>
      </div>

    </div>
    <div id="bet-slip" class="bet-slip-container">
      <!-- Header -->
      <div class="bet-slip-header" onclick="toggleBetSlip()">
        <div class="bet-slip-title">
          <span style="font-size: 1.4rem;">üé´</span>
          <h3>Bet Slip</h3>
        </div>
        <div style="display:flex; align-items:center;">
          <span id="slip-count" class="bet-slip-badge">0</span>
          <span id="bet-slip-toggle-icon" class="bet-slip-toggle-icon">‚ñº</span>
        </div>
      </div>

      <div id="bet-slip-body" class="bet-slip-body">
        <!-- Selections -->
        <div id="slip-items" class="bet-slip-items-container"></div>

        <!-- Parlay Checkbox & Summary -->
        <div id="slip-extras" style="padding: 0 20px;"></div>

        <!-- Stake Input -->
        <div class="bet-slip-stake-section">
          <label
            style="font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 8px;">Stake
            Amount</label>
          <div class="bet-slip-input-wrapper">
            <input id="slip-stake" class="bet-slip-input" type="number" placeholder="Enter stake..." />
            <span class="bet-slip-currency-symbol">$</span>
          </div>
        </div>

        <!-- Potential Win Display -->
        <div id="slip-potential" class="bet-slip-potential">
          <span style="color: #888; font-size: 0.85rem;">Potential Win</span>
          <span id="slip-potential-value"
            style="color: var(--b365-bright-green); font-weight: bold; font-size: 1.2rem;">$0.00</span>
        </div>

        <!-- Action Buttons -->
        <div class="bet-slip-actions">
        <button onclick="saveSlipToCart()" style="
          flex: 1;
          padding: 14px;
          font-size: 0.85rem;
          font-weight: bold;
          border-radius: 10px;
          background: linear-gradient(135deg, #6B46C1 0%, #553C9A 100%);
          color: white;
          border: none;
          cursor: pointer;
          transition: all 0.2s;
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(107, 70, 193, 0.4)';"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
          üõí SAVE
        </button>
        <button class="action-btn" onclick="placeBetsFromSlip()" style="
          flex: 2;
          margin: 0;
          padding: 14px;
          font-size: 0.95rem;
          border-radius: 10px;
          background: linear-gradient(135deg, var(--b365-accent-yellow) 0%, #e6c700 100%);
          box-shadow: 0 4px 15px rgba(255, 223, 27, 0.3);
          transition: all 0.2s;
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255, 223, 27, 0.4)';"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255, 223, 27, 0.3)';">
          üéØ PLACE BET
        </button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDPgcnptW0O2OFlE-_TOsTXctjG6RPBZm8",
      authDomain: "fc26-full-bets.firebaseapp.com",
      databaseURL: "https://fc26-full-bets-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "fc26-full-bets",
      storageBucket: "fc26-full-bets.firebasestorage.app",
      messagingSenderId: "549879537827",
      appId: "1:549879537827:web:cde58dd532e7e6ffde5f16"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null;
    let isAdmin = false;
    let globalTeams = [];
    let globalTeamStats = {};
    let globalMatches = {};
    let betSlip = [];
    let betCart = []; // Saved bet slips for later
    let outrightMarket = { open: false, odds: {} };
    let selectedOutrightTeam = null;

    function debounceRAF(fn) {
      let rafId;
      return (...args) => {
        if (rafId) cancelAnimationFrame(rafId);
        rafId = requestAnimationFrame(() => {
          fn(...args);
          rafId = null;
        });
      };
    }

    // --- AUTH / SESSION ---
    window.onload = function () {
      const savedUser = localStorage.getItem('bet365_user');
      const savedAdmin = localStorage.getItem('bet365_isAdmin');

      // Theme Check
      const savedTheme = localStorage.getItem('bet365_theme');
      if (savedTheme === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
      }

      if (savedUser) {
        currentUser = savedUser;
        isAdmin = (savedAdmin === 'true');
        launch();
      }
    };

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      if (current === 'light') {
        document.documentElement.removeAttribute('data-theme');
        localStorage.setItem('bet365_theme', 'dark');
      } else {
        document.documentElement.setAttribute('data-theme', 'light');
        localStorage.setItem('bet365_theme', 'light');
      }
    }

    // =====================================================
    // NOTIFICATION DROPDOWN FUNCTIONS
    // =====================================================
    let notificationCount = 0;
    const notificationItems = [];

    function toggleNotificationDropdown() {
      const dropdown = document.getElementById('notification-dropdown');
      dropdown.classList.toggle('show');
    }

    function addNotificationToDropdown(message, key) {
      // Check if already in list (prevents duplicates on reload)
      if (notificationItems.find(n => n.key === key)) return;

      notificationItems.unshift({ message, key, timestamp: Date.now() });
      notificationCount++;
      updateNotificationBadge();
      renderNotificationList();
    }

    function updateNotificationBadge() {
      const badge = document.getElementById('notification-badge');
      if (notificationCount > 0) {
        badge.textContent = notificationCount > 99 ? '99+' : notificationCount;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    function renderNotificationList() {
      const list = document.getElementById('notification-list');
      if (notificationItems.length === 0) {
        list.innerHTML = '<div class="notification-empty">No notifications</div>';
        return;
      }

      list.innerHTML = notificationItems.map((item, idx) => `
        <div class="notification-item" onclick="dismissNotification('${item.key}', ${idx})">
          <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <div style="flex:1; padding-right:10px;">${item.message}</div>
            <button onclick="event.stopPropagation(); dismissNotification('${item.key}', ${idx})" 
                    style="background:none; border:none; color:#888; cursor:pointer; font-size:1rem; line-height:1;">&times;</button>
          </div>
        </div>
      `).join('');
    }

    async function dismissNotification(key, index) {
      // Remove from Firebase
      await db.ref(`notifications/${currentUser}/${key}`).remove();

      // Remove from local array
      notificationItems.splice(index, 1);
      notificationCount = Math.max(0, notificationCount - 1);

      updateNotificationBadge();
      renderNotificationList();
    }

    async function clearAllNotifications() {
      // Remove all from Firebase
      await db.ref(`notifications/${currentUser}`).remove();

      // Clear local
      notificationItems.length = 0;
      notificationCount = 0;

      updateNotificationBadge();
      renderNotificationList();

      // Close dropdown
      document.getElementById('notification-dropdown').classList.remove('show');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const notifContainer = document.getElementById('notification-container');
      const notifDropdown = document.getElementById('notification-dropdown');
      if (notifContainer && notifDropdown && !notifContainer.contains(e.target)) {
        notifDropdown.classList.remove('show');
      }

      // Also close cart dropdown
      const cartContainer = document.getElementById('cart-container');
      const cartDropdown = document.getElementById('cart-dropdown');
      if (cartContainer && cartDropdown && !cartContainer.contains(e.target)) {
        cartDropdown.classList.remove('show');
      }
    });

    // =====================================================
    // BET CART FUNCTIONS
    // =====================================================

    function toggleCartDropdown() {
      const dropdown = document.getElementById('cart-dropdown');
      dropdown.classList.toggle('show');
      // Close notification dropdown if open
      document.getElementById('notification-dropdown')?.classList.remove('show');
    }

    function saveSlipToCart() {
      if (betSlip.length === 0) {
        return alert('No selections to save!');
      }

      const isParlay = document.getElementById('is-parlay')?.checked || false;
      const stake = parseFloat(document.getElementById('slip-stake').value) || 0;

      const savedSlip = {
        id: 'cart_' + Date.now(),
        selections: [...betSlip],
        isParlay: isParlay,
        stake: stake,
        savedAt: Date.now(),
        totalOdds: betSlip.reduce((acc, item) => acc * parseFloat(item.odd), 1)
      };

      betCart.push(savedSlip);
      saveCartToStorage();
      updateCartBadge();
      renderCartList();

      // Clear current slip
      betSlip = [];
      document.getElementById('slip-stake').value = '';
      updateBetSlip();

      showNotification('üõí Slip saved to cart!');
    }

    function loadSlipFromCart(cartIndex) {
      const saved = betCart[cartIndex];
      if (!saved) return;

      // Check if matches are still valid (not yet settled)
      const validSelections = saved.selections.filter(item => {
        const m = globalMatches[item.matchId];
        return m && !m.result; // Match exists and not settled
      });

      if (validSelections.length !== saved.selections.length) {
        const invalid = saved.selections.length - validSelections.length;
        showNotification(`‚ö†Ô∏è ${invalid} selection(s) removed (matches settled)`);
      }

      if (validSelections.length === 0) {
        alert('All selections in this slip have been settled. Removing from cart.');
        removeFromCart(cartIndex);
        return;
      }

      // Load into current slip
      betSlip = validSelections;
      document.getElementById('slip-stake').value = saved.stake || '';

      // Remove from cart
      removeFromCart(cartIndex);

      // Update UI
      updateBetSlip();

      // Wait for DOM update then set parlay checkbox
      setTimeout(() => {
        const parlayCheckbox = document.getElementById('is-parlay');
        if (parlayCheckbox && saved.isParlay) {
          parlayCheckbox.checked = true;
          updateBetSlip();
        }
      }, 100);

      // Close cart dropdown
      document.getElementById('cart-dropdown').classList.remove('show');

      showNotification('üìã Slip loaded from cart!');
    }

    function removeFromCart(cartIndex) {
      betCart.splice(cartIndex, 1);
      saveCartToStorage();
      updateCartBadge();
      renderCartList();
    }

    function clearAllCartSlips() {
      if (betCart.length === 0) return;
      if (!confirm('Clear all saved slips?')) return;

      betCart = [];
      saveCartToStorage();
      updateCartBadge();
      renderCartList();
      document.getElementById('cart-dropdown').classList.remove('show');
    }

    function updateCartBadge() {
      const badge = document.getElementById('cart-badge');
      if (!badge) return;

      if (betCart.length > 0) {
        badge.textContent = betCart.length > 99 ? '99+' : betCart.length;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    function renderCartList() {
      const list = document.getElementById('cart-list');
      if (!list) return;

      if (betCart.length === 0) {
        list.innerHTML = '<div class="notification-empty">No saved slips</div>';
        return;
      }

      list.innerHTML = betCart.map((slip, idx) => {
        const selectionCount = slip.selections.length;
        const typeLabel = slip.isParlay ? 'Parlay' : (selectionCount === 1 ? 'Single' : 'Multiple Singles');
        const timeAgo = getTimeAgo(slip.savedAt);

        // Get first few team names for preview
        const preview = slip.selections.slice(0, 2).map(s => {
          const m = globalMatches[s.matchId];
          return m ? `${m.home} vs ${m.away}` : 'Unknown';
        }).join(', ') + (selectionCount > 2 ? ` +${selectionCount - 2} more` : '');

        return `
          <div style="
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: background 0.2s;
          " onmouseover="this.style.background='rgba(107, 70, 193, 0.15)'" 
             onmouseout="this.style.background='transparent'"
             onclick="loadSlipFromCart(${idx})">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
              <span style="
                background: linear-gradient(135deg, #6B46C1, #553C9A);
                color: white;
                padding: 3px 8px;
                border-radius: 4px;
                font-size: 0.7rem;
                font-weight: bold;
              ">${typeLabel}</span>
              <span style="color:#888; font-size:0.75rem;">${timeAgo}</span>
            </div>
            <div style="font-size:0.85rem; color:#ccc; margin-bottom:4px;">${preview}</div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span style="font-size:0.8rem; color:#888;">${selectionCount} selection(s)</span>
              <div style="display:flex; align-items:center; gap:10px;">
                ${slip.stake ? `<span style="color:var(--b365-accent-yellow); font-weight:bold;">$${slip.stake}</span>` : ''}
                <span style="color:var(--b365-bright-green); font-weight:bold;">x${slip.totalOdds.toFixed(2)}</span>
              </div>
            </div>
            <div style="display:flex; gap:8px; margin-top:8px;">
              <button onclick="event.stopPropagation(); loadSlipFromCart(${idx})" style="
                flex:1;
                padding: 6px 10px;
                background: var(--b365-dark-green);
                border: none;
                color: white;
                border-radius: 4px;
                font-size: 0.75rem;
                cursor: pointer;
              ">Load</button>
              <button onclick="event.stopPropagation(); removeFromCart(${idx})" style="
                padding: 6px 10px;
                background: rgba(255,68,68,0.2);
                border: none;
                color: #ff6666;
                border-radius: 4px;
                font-size: 0.75rem;
                cursor: pointer;
              ">Remove</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function saveCartToStorage() {
      localStorage.setItem(`bet365_cart_${currentUser}`, JSON.stringify(betCart));
    }

    function loadCartFromStorage() {
      try {
        const stored = localStorage.getItem(`bet365_cart_${currentUser}`);
        betCart = stored ? JSON.parse(stored) : [];
        updateCartBadge();
        renderCartList();
      } catch (e) {
        betCart = [];
      }
    }

    function getTimeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      return Math.floor(seconds / 86400) + 'd ago';
    }

    function handleLogin() {
      const user = document.getElementById('userIn').value.trim();
      const pass = document.getElementById('passIn').value;
      if (user === 'Admin' && pass === 'IBM99ibm') {
        setUserSession('Admin', true);
      } else {
        db.ref('users/' + user).once('value', s => {
          const d = s.val();
          if (d && d.pass === pass) setUserSession(user, false);
          else alert('Invalid Login');
        });
      }
    }

    function setUserSession(user, adminStatus) {
      currentUser = user;
      isAdmin = adminStatus;
      localStorage.setItem('bet365_user', user);
      localStorage.setItem('bet365_isAdmin', adminStatus);
      launch();
    }

    function logout() {
      localStorage.removeItem('bet365_user');
      localStorage.removeItem('bet365_isAdmin');
      location.reload();
    }

    function launch() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('display-name').textContent = currentUser;
      document.getElementById('headerUser').textContent = currentUser;
      if (isAdmin) {
        document.getElementById('admin-tabs').style.display = 'flex';
        document.getElementById('admin-content').style.display = 'block';
      } else {
        document.getElementById('user-content').style.display = 'block';
        document.getElementById('notification-container').style.display = 'block';
        document.getElementById('cart-container').style.display = 'block';
        loadCartFromStorage(); // Load saved cart from localStorage
        db.ref(`users/${currentUser}/credits`).on('value', s => {
          document.getElementById('display-balance').textContent = s.val() || 0;
        });
      }
      initListeners();
    }

    function switchTab(id, el) {
      document.querySelectorAll('.tab-pane').forEach(p => p.style.display = 'none');
      document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
      document.getElementById(id).style.display = 'block';
      el.classList.add('active');
    }

    function switchUserTab(id, el) {
      document.querySelectorAll('.user-tab-pane').forEach(p => p.style.display = 'none');
      document.querySelectorAll('#user-tabs .tab-item').forEach(t => t.classList.remove('active'));
      document.getElementById(id).style.display = 'block';
      el.classList.add('active');
    }

    // --- DATA SYNC ---
    function initListeners() {
      db.ref('teams').on('value', s => {
        globalTeams = Object.values(s.val() || {});
        updateDropdowns(globalTeams);
        if (isAdmin) renderAdminTeamsTable(globalTeams);
        updateStandings(globalTeams, globalMatches);
        if (isAdmin) refreshAdminUserView();
      });

      const renderMatchesDebounced = debounceRAF(() => {
        if (isAdmin) {
          renderAdminMatches(globalMatches);
          renderBracketView(globalMatches);
          // Ensure team table is visible even if teams listener fired early
          if (globalTeams.length) renderAdminTeamsTable(globalTeams);
        } else {
          renderUserOdds(globalMatches);
          renderMyMatches(globalMatches); // Self-report feature
        }
        if (globalTeams.length) updateStandings(globalTeams, globalMatches);
      });

      db.ref('matches').on('value', s => {
        globalMatches = s.val() || {};
        renderMatchesDebounced();
      });

      // Bets listener for Admin Active Bets tab
      if (isAdmin) {
        // Combined Ref for Admin History
        const histRef = db.ref('history');
        const parlaysRef = db.ref('parlays');

        histRef.on('value', s => {
          const h = s.val();
          parlaysRef.once('value', p => {
            renderAdminBetHistory(h, p.val(), globalMatches);
            renderAnalytics(h); // Analytics might need parlay update too eventually
          });
        });
        parlaysRef.on('value', s => {
          const p = s.val();
          histRef.once('value', h => {
            renderAdminBetHistory(h.val(), p, globalMatches);
            renderActiveParlays(p, globalMatches); // New function for active parlays
          });
        });

        db.ref('bets').on('value', s => {
          renderActiveBets(s.val(), globalMatches);
        });
        db.ref('users').on('value', s => {
          renderAdminUserList(s.val());
        });
      } else {
        // User Consumers
        const histRef = db.ref(`history/${currentUser}`);
        const parlaysRef = db.ref(`parlays/${currentUser}`);

        histRef.on('value', s => {
          const h = s.val();
          parlaysRef.once('value', p => {
            renderUserBetHistory(h, p.val(), globalMatches);
          });
        });
        parlaysRef.on('value', s => {
          const p = s.val();
          histRef.once('value', h => {
            renderUserBetHistory(h.val(), p, globalMatches);
          });
        });

        // Notification listener - add to dropdown and show toast
        db.ref(`notifications/${currentUser}`).on('child_added', s => {
          const msg = s.val();
          const key = s.key;
          addNotificationToDropdown(msg, key);
          showNotification(msg);
        });

        // Load existing notifications on startup
        db.ref(`notifications/${currentUser}`).once('value', s => {
          const notifs = s.val() || {};
          Object.entries(notifs).forEach(([key, msg]) => {
            addNotificationToDropdown(msg, key);
          });
        });
      }

      // Outright Market Listener
      db.ref('outright_market').on('value', s => {
        const data = s.val() || { open: false, odds: {} };
        outrightMarket = data;
        if (isAdmin) {
          renderAdminOutrightTeams();
          updateOutrightMarketStatus();
        } else {
          renderUserOutrightSection();
        }
      });

      // Outright Bets Listener
      if (isAdmin) {
        db.ref('outright_bets').on('value', s => {
          renderAdminOutrightBets(s.val());
        });
      } else {
        db.ref(`outright_bets/${currentUser}`).on('value', s => {
          renderUserExistingOutrightBet(s.val());
          renderUserActiveOutright(s.val());
        });

        // User's active bets listener for My Bets tab
        db.ref(`bets/${currentUser}`).on('value', s => {
          renderUserActiveBetsList(s.val());
        });

        // User's active parlays listener for My Bets tab
        db.ref(`parlays/${currentUser}`).on('value', s => {
          renderUserActiveParlaysList(s.val());
        });

        // Leaderboard listener (all users)
        db.ref('users').on('value', s => {
          renderLeaderboard(s.val());
        });

        // Resolved bets listener (history + parlays with won/lost/cashed_out status)
        db.ref(`history/${currentUser}`).on('value', histSnap => {
          db.ref(`parlays/${currentUser}`).once('value', parlaySnap => {
            renderUserResolvedBets(histSnap.val(), parlaySnap.val());
          });
        });
        db.ref(`parlays/${currentUser}`).on('value', parlaySnap => {
          db.ref(`history/${currentUser}`).once('value', histSnap => {
            renderUserResolvedBets(histSnap.val(), parlaySnap.val());
          });
        });
      }
    }

    function refreshAdminUserView() {
      db.ref('users').once('value', s => renderAdminUserList(s.val()));
    }

    // --- TEAM MGMT ---
    async function registerTeam() {
      const name = document.getElementById('tName').value.trim();
      const group = document.getElementById('tGroup').value;
      if (!name) return;
      const id = 't_' + Date.now();
      await db.ref('teams/' + id).set({ id, name, group, history: ['-', '-', '-', '-', '-'] });
      document.getElementById('tName').value = '';
    }

    async function updateTeamData(id, field, value) {
      await db.ref(`teams/${id}/${field}`).set(value);
    }

    async function updateHistory(id, index, val) {
      const clean = val.trim() === '-' ? '-' : (parseFloat(val) || 0);
      await db.ref(`teams/${id}/history/${index}`).set(clean);
    }

    async function deleteTeam(id) {
      if (confirm('Remove team?')) await db.ref(`teams/${id}`).remove();
    }

    // --- ODDS CALC ---
    function calculateOddsForTeams(t1, t2) {
      let sH = calcStrength(t1.history);
      let sA = calcStrength(t2.history);
      if (sH === 0 && sA === 0) { sH = 1; sA = 1; }
      if (sH === 0) sH = 0.1;
      if (sA === 0) sA = 0.1;

      const total = sH + sA;
      const pH = (sH / total) * 0.88;
      const pA = (sA / total) * 0.88;
      const pX = 0.12;

      const o1 = (1 / pH).toFixed(2);
      const oX = (1 / pX).toFixed(2);
      const o2 = (1 / pA).toFixed(2);
      const finalOX = Math.min(Math.max(oX, 2.50), 6.50).toFixed(2);
      return { '1': o1, 'X': finalOX, '2': o2 };
    }

    async function suggestOddsDOM() {
      const hId = document.getElementById('gmHome').value;
      const aId = document.getElementById('gmAway').value;
      const t1 = globalTeams.find(t => t.id === hId);
      const t2 = globalTeams.find(t => t.id === aId);
      if (t1 && t2) {
        const odds = calculateOddsForTeams(t1, t2);
        document.getElementById('o1').value = odds['1'];
        document.getElementById('oX').value = odds['X'];
        document.getElementById('o2').value = odds['2'];
      }
    }

    function calcStrength(hist) {
      if (!hist) return 0;
      const arr = Array.isArray(hist) ? hist : Object.values(hist);
      const nums = arr.filter(x => x !== '-' && !isNaN(parseFloat(x))).map(Number);
      if (nums.length === 0) return 0;
      return nums.reduce((a, b) => a + b, 0) / nums.length;
    }

    // --- GENERATORS ---
    async function generateGroupMatches(legs) {
      if (!confirm(`Generate ${legs}-leg matches for A, B, C, D (Excluding E)?`)) return;

      // Check existing matches to prevent duplicates
      const checkExists = (hId, aId) => {
        return Object.values(globalMatches || {}).some(m => m.homeId === hId && m.awayId === aId);
      };

      const grouped = {};
      globalTeams.forEach(t => {
        if (t.group === 'E') return; // EXCLUDE E
        if (!grouped[t.group]) grouped[t.group] = [];
        grouped[t.group].push(t);
      });

      const updates = {};
      let count = 0;
      let skipped = 0;

      Object.keys(grouped).forEach(grp => {
        const teams = grouped[grp];
        // Ensure unique teams (handle potential duplicate team entries if any)
        const uniqueTeams = [];
        const seenIds = new Set();
        teams.forEach(t => {
          if (!seenIds.has(t.id)) {
            seenIds.add(t.id);
            uniqueTeams.push(t);
          }
        });

        for (let i = 0; i < uniqueTeams.length; i++) {
          for (let j = i + 1; j < uniqueTeams.length; j++) {
            const tA = uniqueTeams[i];
            const tB = uniqueTeams[j];

            // Leg 1
            if (!checkExists(tA.id, tB.id)) {
              const odds1 = calculateOddsForTeams(tA, tB);
              const id1 = 'm_' + Date.now() + '_' + Math.floor(Math.random() * 100000);
              updates[`matches/${id1}`] = { home: tA.name, homeId: tA.id, away: tB.name, awayId: tB.id, odds: odds1, result: null, group: grp };
              count++;
            } else {
              skipped++;
            }

            // Leg 2
            if (legs === 2) {
              if (!checkExists(tB.id, tA.id)) {
                const odds2 = calculateOddsForTeams(tB, tA);
                const id2 = 'm_' + (Date.now() + 1) + '_' + Math.floor(Math.random() * 100000);
                updates[`matches/${id2}`] = { home: tB.name, homeId: tB.id, away: tA.name, awayId: tA.id, odds: odds2, result: null, group: grp };
                count++;
              } else {
                skipped++;
              }
            }
          }
        }
      });

      if (count > 0) {
        await db.ref().update(updates);
        alert(`Successfully generated ${count} matches. (Skipped ${skipped} duplicates)`);
      } else {
        alert(`No new matches generated. (Skipped ${skipped} duplicates)`);
      }
    }

    // --- BRACKET LOGIC ---
    async function initBracket() {
      const stageType = document.getElementById('stageType').value;
      const legType = document.getElementById('sfType').value;
      const updates = {};
      const now = Date.now();

      if (stageType === 'QF') {
        // Quarter-Finals mode - need 8 teams (4 matches)
        const qf1H = globalTeams.find(t => t.id === document.getElementById('brQF1H').value);
        const qf1A = globalTeams.find(t => t.id === document.getElementById('brQF1A').value);
        const qf2H = globalTeams.find(t => t.id === document.getElementById('brQF2H').value);
        const qf2A = globalTeams.find(t => t.id === document.getElementById('brQF2A').value);
        const qf3H = globalTeams.find(t => t.id === document.getElementById('brQF3H').value);
        const qf3A = globalTeams.find(t => t.id === document.getElementById('brQF3A').value);
        const qf4H = globalTeams.find(t => t.id === document.getElementById('brQF4H').value);
        const qf4A = globalTeams.find(t => t.id === document.getElementById('brQF4A').value);

        if (!qf1H || !qf1A || !qf2H || !qf2A || !qf3H || !qf3A || !qf4H || !qf4A) {
          return alert("Select all 8 Quarter-Finalists");
        }

        // Check for duplicate teams
        const allQFTeams = [qf1H, qf1A, qf2H, qf2A, qf3H, qf3A, qf4H, qf4A];
        const teamIds = allQFTeams.map(t => t.id);
        const uniqueIds = new Set(teamIds);
        if (uniqueIds.size !== teamIds.length) {
          return alert("Each team can only appear once in the bracket! Please ensure all 8 teams are unique.");
        }

        // Create QF matches
        const o1 = calculateOddsForTeams(qf1H, qf1A);
        const o2 = calculateOddsForTeams(qf2H, qf2A);
        const o3 = calculateOddsForTeams(qf3H, qf3A);
        const o4 = calculateOddsForTeams(qf4H, qf4A);

        updates[`matches/br_qf1_L1`] = { home: qf1H.name, homeId: qf1H.id, away: qf1A.name, awayId: qf1A.id, odds: o1, result: null, stage: 'QF1', bracketId: 'qf1' };
        updates[`matches/br_qf2_L1`] = { home: qf2H.name, homeId: qf2H.id, away: qf2A.name, awayId: qf2A.id, odds: o2, result: null, stage: 'QF2', bracketId: 'qf2' };
        updates[`matches/br_qf3_L1`] = { home: qf3H.name, homeId: qf3H.id, away: qf3A.name, awayId: qf3A.id, odds: o3, result: null, stage: 'QF3', bracketId: 'qf3' };
        updates[`matches/br_qf4_L1`] = { home: qf4H.name, homeId: qf4H.id, away: qf4A.name, awayId: qf4A.id, odds: o4, result: null, stage: 'QF4', bracketId: 'qf4' };

        if (legType === '2') {
          const o1r = calculateOddsForTeams(qf1A, qf1H);
          const o2r = calculateOddsForTeams(qf2A, qf2H);
          const o3r = calculateOddsForTeams(qf3A, qf3H);
          const o4r = calculateOddsForTeams(qf4A, qf4H);
          updates[`matches/br_qf1_L2`] = { home: qf1A.name, homeId: qf1A.id, away: qf1H.name, awayId: qf1H.id, odds: o1r, result: null, stage: 'QF1', bracketId: 'qf1' };
          updates[`matches/br_qf2_L2`] = { home: qf2A.name, homeId: qf2A.id, away: qf2H.name, awayId: qf2H.id, odds: o2r, result: null, stage: 'QF2', bracketId: 'qf2' };
          updates[`matches/br_qf3_L2`] = { home: qf3A.name, homeId: qf3A.id, away: qf3H.name, awayId: qf3H.id, odds: o3r, result: null, stage: 'QF3', bracketId: 'qf3' };
          updates[`matches/br_qf4_L2`] = { home: qf4A.name, homeId: qf4A.id, away: qf4H.name, awayId: qf4H.id, odds: o4r, result: null, stage: 'QF4', bracketId: 'qf4' };
        }

        // Add SF placeholders (pending, will be filled when QF completes)
        updates[`matches/br_sf1_L1`] = { home: 'TBD', homeId: 'TBD', away: 'TBD', awayId: 'TBD', odds: { 1: 0, X: 0, 2: 0 }, result: null, stage: 'SF1', pending: true };
        updates[`matches/br_sf2_L1`] = { home: 'TBD', homeId: 'TBD', away: 'TBD', awayId: 'TBD', odds: { 1: 0, X: 0, 2: 0 }, result: null, stage: 'SF2', pending: true };

        // Add Final/3rd placeholders
        updates[`matches/br_final`] = { home: 'TBD', homeId: 'TBD', away: 'TBD', awayId: 'TBD', odds: { 1: 0, X: 0, 2: 0 }, result: null, stage: 'FINAL', pending: true };
        updates[`matches/br_3rd`] = { home: 'TBD', homeId: 'TBD', away: 'TBD', awayId: 'TBD', odds: { 1: 0, X: 0, 2: 0 }, result: null, stage: '3RD', pending: true };

      } else {
        // Semi-Finals mode - need 4 teams (2 matches)
        const sf1H = globalTeams.find(t => t.id === document.getElementById('brSF1H').value);
        const sf1A = globalTeams.find(t => t.id === document.getElementById('brSF1A').value);
        const sf2H = globalTeams.find(t => t.id === document.getElementById('brSF2H').value);
        const sf2A = globalTeams.find(t => t.id === document.getElementById('brSF2A').value);

        if (!sf1H || !sf1A || !sf2H || !sf2A) return alert("Select all 4 Semi-Finalists");

        // Check for duplicate teams
        const allSFTeams = [sf1H, sf1A, sf2H, sf2A];
        const teamIds = allSFTeams.map(t => t.id);
        const uniqueIds = new Set(teamIds);
        if (uniqueIds.size !== teamIds.length) {
          return alert("Each team can only appear once in the bracket! Please ensure all 4 teams are unique.");
        }

        // Create SF matches as active betting events
        const o1 = calculateOddsForTeams(sf1H, sf1A);
        const o2 = calculateOddsForTeams(sf2H, sf2A);

        updates[`matches/br_sf1_L1`] = { home: sf1H.name, homeId: sf1H.id, away: sf1A.name, awayId: sf1A.id, odds: o1, result: null, stage: 'SF1', bracketId: 'sf1' };
        updates[`matches/br_sf2_L1`] = { home: sf2H.name, homeId: sf2H.id, away: sf2A.name, awayId: sf2A.id, odds: o2, result: null, stage: 'SF2', bracketId: 'sf2' };

        if (legType === '2') {
          const o1r = calculateOddsForTeams(sf1A, sf1H);
          const o2r = calculateOddsForTeams(sf2A, sf2H);
          updates[`matches/br_sf1_L2`] = { home: sf1A.name, homeId: sf1A.id, away: sf1H.name, awayId: sf1H.id, odds: o1r, result: null, stage: 'SF1', bracketId: 'sf1' };
          updates[`matches/br_sf2_L2`] = { home: sf2A.name, homeId: sf2A.id, away: sf2H.name, awayId: sf2H.id, odds: o2r, result: null, stage: 'SF2', bracketId: 'sf2' };
        }

        // Add Placeholders for Final/3rd (NOT BETTABLE YET)
        updates[`matches/br_final`] = { home: 'TBD', homeId: 'TBD', away: 'TBD', awayId: 'TBD', odds: { 1: 0, X: 0, 2: 0 }, result: null, stage: 'FINAL', pending: true };
        updates[`matches/br_3rd`] = { home: 'TBD', homeId: 'TBD', away: 'TBD', awayId: 'TBD', odds: { 1: 0, X: 0, 2: 0 }, result: null, stage: '3RD', pending: true };
      }

      await db.ref().update(updates);
    }

    // Check if QFs/SFs are done and spawn next stage
    async function checkBracketProgression(matches) {
      const isDone = (arr) => arr.length > 0 && arr.every(m => m.result);

      const getWinnerLoser = (ms) => {
        // Simple aggregate score logic
        let hId = ms[0].homeId, aId = ms[0].awayId;
        let hName = ms[0].home, aName = ms[0].away;
        let hScore = 0, aScore = 0;

        ms.forEach(m => {
          const [h, a] = m.result.split('-').map(Number);
          if (m.homeId === hId) { hScore += h; aScore += a; }
          else { hScore += a; aScore += h; } // Inverted leg
        });

        if (hScore > aScore) return { wId: hId, wName: hName, lId: aId, lName: aName };
        if (aScore > hScore) return { wId: aId, wName: aName, lId: hId, lName: hName };
        // Tie-break (random/away goals not impl, taking home for now)
        return { wId: hId, wName: hName, lId: aId, lName: aName };
      };

      // Check for Quarter-Finals progression to Semi-Finals
      const qf1Matches = Object.values(matches).filter(m => m.stage === 'QF1');
      const qf2Matches = Object.values(matches).filter(m => m.stage === 'QF2');
      const qf3Matches = Object.values(matches).filter(m => m.stage === 'QF3');
      const qf4Matches = Object.values(matches).filter(m => m.stage === 'QF4');

      const hasQFMatches = qf1Matches.length > 0 || qf2Matches.length > 0 || qf3Matches.length > 0 || qf4Matches.length > 0;

      if (hasQFMatches) {
        const qf1Done = isDone(qf1Matches);
        const qf2Done = isDone(qf2Matches);
        const qf3Done = isDone(qf3Matches);
        const qf4Done = isDone(qf4Matches);

        // Check if SFs are still pending (TBD)
        const sf1Key = Object.keys(matches).find(k => matches[k].stage === 'SF1');
        const sf1Match = sf1Key ? matches[sf1Key] : null;

        if (qf1Done && qf2Done && qf3Done && qf4Done && sf1Match && sf1Match.pending) {
          // All QFs done, advance to SFs
          const resQF1 = getWinnerLoser(qf1Matches);
          const resQF2 = getWinnerLoser(qf2Matches);
          const resQF3 = getWinnerLoser(qf3Matches);
          const resQF4 = getWinnerLoser(qf4Matches);

          // SF1: QF1 winner vs QF2 winner
          // SF2: QF3 winner vs QF4 winner
          const tSF1H = globalTeams.find(t => t.id === resQF1.wId);
          const tSF1A = globalTeams.find(t => t.id === resQF2.wId);
          const tSF2H = globalTeams.find(t => t.id === resQF3.wId);
          const tSF2A = globalTeams.find(t => t.id === resQF4.wId);

          const oddsSF1 = calculateOddsForTeams(tSF1H, tSF1A);
          const oddsSF2 = calculateOddsForTeams(tSF2H, tSF2A);

          const sf2Key = Object.keys(matches).find(k => matches[k].stage === 'SF2');

          const updates = {};
          updates[`matches/${sf1Key}`] = {
            home: resQF1.wName, homeId: resQF1.wId,
            away: resQF2.wName, awayId: resQF2.wId,
            odds: oddsSF1, result: null, stage: 'SF1', pending: null, bracketId: 'sf1'
          };
          updates[`matches/${sf2Key}`] = {
            home: resQF3.wName, homeId: resQF3.wId,
            away: resQF4.wName, awayId: resQF4.wId,
            odds: oddsSF2, result: null, stage: 'SF2', pending: null, bracketId: 'sf2'
          };

          await db.ref().update(updates);
          alert("Semi-Finals Set! Betting is open.");
          return;
        }
      }

      // Check for Semi-Finals to Finals progression
      const sf1Matches = Object.values(matches).filter(m => m.stage === 'SF1' && !m.pending);
      const sf2Matches = Object.values(matches).filter(m => m.stage === 'SF2' && !m.pending);

      if (sf1Matches.length === 0) return;

      const sf1Done = isDone(sf1Matches);
      const sf2Done = isDone(sf2Matches);

      // Get the Final/3rd placeholders
      const finalMatchKey = Object.keys(matches).find(k => matches[k].stage === 'FINAL');
      const thirdMatchKey = Object.keys(matches).find(k => matches[k].stage === '3RD');

      if (!finalMatchKey || !thirdMatchKey) return; // Should exist if bracket init

      const finalMatch = matches[finalMatchKey];

      // Only proceed if SFs are done AND Final is still TBD/Pending
      if (sf1Done && sf2Done && finalMatch.pending) {

        const res1 = getWinnerLoser(sf1Matches);
        const res2 = getWinnerLoser(sf2Matches);

        // Calculate Odds
        const tW1 = globalTeams.find(t => t.id === res1.wId);
        const tW2 = globalTeams.find(t => t.id === res2.wId);
        const tL1 = globalTeams.find(t => t.id === res1.lId);
        const tL2 = globalTeams.find(t => t.id === res2.lId);

        const oddsFinal = calculateOddsForTeams(tW1, tW2);
        const odds3rd = calculateOddsForTeams(tL1, tL2);

        const updates = {};
        // Enable Final
        updates[`matches/${finalMatchKey}`] = {
          home: res1.wName, homeId: res1.wId,
          away: res2.wName, awayId: res2.wId,
          odds: oddsFinal, result: null, stage: 'FINAL', pending: null // REMOVE PENDING
        };
        // Enable 3rd
        updates[`matches/${thirdMatchKey}`] = {
          home: res1.lName, homeId: res1.lId,
          away: res2.lName, awayId: res2.lId,
          odds: odds3rd, result: null, stage: '3RD', pending: null // REMOVE PENDING
        };

        await db.ref().update(updates);
        alert("Finals & 3rd Place Set! Betting is open.");
      }
    }

    // --- ARCHIVE & COEFFICIENTS ---
    // --- ARCHIVE & COEFFICIENTS ---
    async function archiveTournament() {
      showConfirm("Archive Season?", "‚ö†Ô∏è This will:\n1. Calc Coefficient Points\n2. Shift History\n3. DELETE all Matches & Bets.", async () => {

        const updates = {};
        const teamPoints = {}; // { teamId: points }

        // Init points
        globalTeams.forEach(t => teamPoints[t.id] = 0);

        // 1. Calculate Points from Matches
        Object.values(globalMatches).forEach(m => {
          if (!m.result) return;
          const [h, a] = m.result.split('-').map(Number);

          // Win/Draw Points (Applicable to ALL matches including playoffs? 
          // "3rd placement match does not earn extra points but the winner does get the usual 2 for win")
          // Logic: Apply 2 for win, 1 for draw to EVERY match played.
          if (h > a) { teamPoints[m.homeId] += 2; }
          else if (a > h) { teamPoints[m.awayId] += 2; }
          else { teamPoints[m.homeId] += 1; teamPoints[m.awayId] += 1; }
        });

        // 2. Bonus Points based on "Reaching" Stages (Robust method)
        // Identify participants
        const sfs = new Set();
        const finalists = new Set();
        let championId = null;

        Object.values(globalMatches).forEach(m => {
          if (m.stage && (m.stage.startsWith('SF'))) {
            sfs.add(m.homeId); sfs.add(m.awayId);
          }
          if (m.stage === 'FINAL') {
            finalists.add(m.homeId); finalists.add(m.awayId);
            if (m.result) {
              const [h, a] = m.result.split('-').map(Number);
              if (h > a) championId = m.homeId;
              else if (a > h) championId = m.awayId;
            }
          }
        });

        // Apply Bonuses
        sfs.forEach(tid => { if (teamPoints[tid] !== undefined) teamPoints[tid] += 1; }); // Reach SF
        finalists.forEach(tid => { if (teamPoints[tid] !== undefined) teamPoints[tid] += 1; }); // Reach Final
        if (championId && teamPoints[championId] !== undefined) teamPoints[championId] += 1; // Winner

        // 3. Shift History & Set New Coeff
        globalTeams.forEach(t => {
          let arr = t.history ? [...t.history] : ['-', '-', '-', '-', '-'];
          for (let i = 0; i < arr.length - 1; i++) arr[i] = arr[i + 1]; // Shift Left

          // Set New Score
          arr[arr.length - 1] = teamPoints[t.id] || 0;
          updates[`teams/${t.id}/history`] = arr;
        });

        // 4. Wipe Matches & Bets
        updates['matches'] = null;
        updates['bets'] = null;

        await db.ref().update(updates);
        showNotification("Season Archived. Points Calculated.");
      });
    }


    // --- STANDARD MATCH FUNCTIONS ---
    function createMatch() {
      const hId = document.getElementById('gmHome').value;
      const aId = document.getElementById('gmAway').value;

      // Prevent same team as both participants
      if (hId === aId) {
        alert('Cannot create match: Home and Away teams must be different!');
        return;
      }

      const hName = document.querySelector('#gmHome option:checked').textContent;
      const aName = document.querySelector('#gmAway option:checked').textContent;
      const odds = {
        '1': document.getElementById('o1').value,
        'X': document.getElementById('oX').value,
        '2': document.getElementById('o2').value
      };
      db.ref('matches/m_' + Date.now()).set({ home: hName, homeId: hId, away: aName, awayId: aId, odds, result: null });
    }

    // --- MODAL UTILS ---
    let confirmCallback = null;
    let promptCallback = null;

    function showConfirm(title, msg, onConfirm) {
      document.getElementById('confirm-title').textContent = title;
      document.getElementById('confirm-msg').textContent = msg;
      confirmCallback = onConfirm;
      document.getElementById('confirm-modal').style.display = 'flex';
    }

    function closeConfirmModal() {
      document.getElementById('confirm-modal').style.display = 'none';
      confirmCallback = null;
    }

    function onConfirmYes() {
      if (confirmCallback) confirmCallback();
      closeConfirmModal();
    }

    function showPrompt(title, msg, onOk) {
      document.getElementById('prompt-title').textContent = title;
      document.getElementById('prompt-msg').textContent = msg;
      document.getElementById('prompt-input').value = '';
      promptCallback = onOk;
      document.getElementById('prompt-modal').style.display = 'flex';
      setTimeout(() => document.getElementById('prompt-input').focus(), 100);
    }

    function closePromptModal() {
      document.getElementById('prompt-modal').style.display = 'none';
      promptCallback = null;
    }

    function onPromptOk() {
      const val = document.getElementById('prompt-input').value;
      if (promptCallback) promptCallback(val);
      closePromptModal();
    }

    // Bind Modal Events
    document.getElementById('confirm-btn-action').onclick = onConfirmYes;
    document.getElementById('prompt-btn-action').onclick = onPromptOk;

    // Score Modal State
    let currentScoreMatchId = null;

    function setScore(id) {
      const match = globalMatches[id];
      if (!match) {
        alert('Match not found');
        return;
      }

      currentScoreMatchId = id;
      document.getElementById('score-modal-title').textContent = 'Set Match Score';
      document.getElementById('score-home-name').textContent = match.home;
      document.getElementById('score-away-name').textContent = match.away;
      document.getElementById('score-home-input').value = 0;
      document.getElementById('score-away-input').value = 0;
      document.getElementById('score-modal').style.display = 'flex';
    }

    function closeScoreModal() {
      document.getElementById('score-modal').style.display = 'none';
      currentScoreMatchId = null;
    }

    async function confirmSetScore() {
      if (!currentScoreMatchId) return;

      const homeScore = parseInt(document.getElementById('score-home-input').value) || 0;
      const awayScore = parseInt(document.getElementById('score-away-input').value) || 0;

      if (homeScore < 0 || awayScore < 0 || homeScore > 99 || awayScore > 99) {
        alert('Invalid score. Please enter values between 0-99.');
        return;
      }

      const res = `${homeScore}-${awayScore}`;
      const id = currentScoreMatchId;

      closeScoreModal();

      await db.ref(`matches/${id}/result`).set(res);
      const betsSnap = await db.ref('bets').once('value');
      const allBets = betsSnap.val() || {};
      const updates = {};
      for (const [user, userBets] of Object.entries(allBets)) {
        if (userBets[id]) {
          const bet = userBets[id];
          const [h, a] = res.split('-').map(Number);
          const actual = h > a ? '1' : h < a ? '2' : 'X';
          const win = bet.outcome === actual;
          const payout = win ? bet.stake * bet.odd : bet.stake;
          const profit = payout - bet.stake;
          const userSnap = await db.ref(`users/${user}/credits`).once('value');
          const cur = userSnap.val() || 0;
          updates[`users/${user}/credits`] = cur + payout;
          updates[`history/${user}/${id}`] = { ...bet, win, profit, result: res };
          updates[`bets/${user}/${id}`] = null;
          const notifKey = firebase.database().ref(`notifications/${user}`).push().key;
          const notifMsg = win
            ? `‚úÖ WON! ${globalMatches[id].home} vs ${globalMatches[id].away} - Payout: +${payout.toFixed(2)}`
            : `‚ùå LOST! ${globalMatches[id].home} vs ${globalMatches[id].away} - Stake lost: ${bet.stake}`;
          updates[`notifications/${user}/${notifKey}`] = notifMsg;
        }
      }
      await db.ref().update(updates);

      // Check Parlays
      try {
        await checkParlays(id, res);
      } catch (e) { console.error("Parlay check failed", e); }

      const snap = await db.ref('matches').get();
      checkBracketProgression(snap.val());
    }

    // =====================================================
    // SELF-REPORT FUNCTIONS
    // =====================================================

    // Check if current user's name matches a team name in the match
    function isMatchParticipant(match) {
      if (!currentUser || isAdmin) return false;
      const userLower = currentUser.toLowerCase();
      return match.home.toLowerCase() === userLower || match.away.toLowerCase() === userLower;
    }

    // Get user's role in the match (home or away)
    function getUserMatchRole(match) {
      if (!currentUser) return null;
      const userLower = currentUser.toLowerCase();
      if (match.home.toLowerCase() === userLower) return 'home';
      if (match.away.toLowerCase() === userLower) return 'away';
      return null;
    }

    // Render matches where current user is a participant
    function renderMyMatches(matches) {
      const container = document.getElementById('my-matches-list');
      if (!container) return;

      const myMatches = Object.entries(matches)
        .filter(([id, m]) => !m.pending && isMatchParticipant(m))
        .map(([id, m]) => ({ id, ...m }));

      if (myMatches.length === 0) {
        container.innerHTML = `
          <div style="padding:30px; text-align:center; color:#888;">
            <div style="font-size:2rem; margin-bottom:10px;">üìã</div>
            <div>No matches found where your username matches a team name.</div>
            <div style="font-size:0.85rem; margin-top:10px; color:#666;">
              Your username: <strong>${currentUser}</strong>
            </div>
          </div>
        `;
        return;
      }

      const html = myMatches.map(m => {
        const role = getUserMatchRole(m);
        const opponent = role === 'home' ? m.away : m.home;
        const selfReports = m.selfReports || {};
        const myReport = selfReports[role];
        const opponentRole = role === 'home' ? 'away' : 'home';
        const opponentReport = selfReports[opponentRole];

        // Determine status
        let statusClass = 'pending';
        let statusText = 'No Reports';
        let showInput = true;

        if (m.result) {
          statusClass = 'matched';
          statusText = `Final: ${m.result}`;
          showInput = false;
        } else if (myReport && opponentReport) {
          if (myReport === opponentReport) {
            statusClass = 'matched';
            statusText = 'Matched! Processing...';
            showInput = false;
          } else {
            statusClass = 'conflict';
            statusText = 'Conflict - Admin needed';
            showInput = false;
          }
        } else if (myReport) {
          statusClass = 'reported';
          statusText = 'Awaiting opponent';
          showInput = false;
        } else if (opponentReport) {
          statusClass = 'reported';
          statusText = 'Opponent reported';
        }

        // Build report display
        let reportInfo = '';
        if (myReport && !m.result) {
          reportInfo += `<div class="your-report">Your report: ${myReport}</div>`;
        }
        if (opponentReport && !m.result) {
          reportInfo += `<div class="opponent-report">${opponent}'s report: ${opponentReport}</div>`;
        }

        // Input form or result display
        let actionHtml = '';
        if (m.result) {
          actionHtml = `<span style="font-size:1.2rem; font-weight:bold; color:var(--b365-accent-yellow);">${m.result}</span>`;
        } else if (showInput) {
          actionHtml = `
            <div class="report-input-group">
              <input type="number" id="report-home-${m.id}" min="0" max="99" placeholder="0" />
              <span>-</span>
              <input type="number" id="report-away-${m.id}" min="0" max="99" placeholder="0" />
            </div>
            <button class="report-btn" onclick="submitSelfReport('${m.id}', '${role}')">Report</button>
          `;
        } else if (myReport && !m.result) {
          actionHtml = `
            <div style="text-align:right;">
              <div style="font-size:0.8rem; color:#888;">Your report submitted</div>
              <div style="font-size:1.1rem; font-weight:bold; color:var(--b365-accent-yellow);">${myReport}</div>
            </div>
          `;
        }

        return `
          <div class="my-match-item">
            <div class="my-match-info">
              <div class="my-match-teams">${m.home} vs ${m.away}</div>
              <div class="my-match-meta">${m.stage || 'Group ' + (m.group || 'Match')}</div>
              ${reportInfo}
            </div>
            <div class="my-match-actions">
              <span class="report-status ${statusClass}">${statusText}</span>
              ${actionHtml}
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html || '<div style="padding:20px; color:#888;">No matches to report.</div>';
    }

    // Submit a self-report for a match
    async function submitSelfReport(matchId, role) {
      const homeInput = document.getElementById(`report-home-${matchId}`);
      const awayInput = document.getElementById(`report-away-${matchId}`);

      if (!homeInput || !awayInput) {
        alert('Error: Could not find input fields');
        return;
      }

      const homeScore = parseInt(homeInput.value) || 0;
      const awayScore = parseInt(awayInput.value) || 0;

      if (homeScore < 0 || awayScore < 0 || homeScore > 99 || awayScore > 99) {
        alert('Invalid score. Please enter values between 0-99.');
        return;
      }

      const reportedScore = `${homeScore}-${awayScore}`;

      try {
        // Save the self-report
        await db.ref(`matches/${matchId}/selfReports/${role}`).set(reportedScore);

        // Check if both teams have reported
        const matchSnap = await db.ref(`matches/${matchId}`).once('value');
        const match = matchSnap.val();

        if (match.selfReports) {
          const homeReport = match.selfReports.home;
          const awayReport = match.selfReports.away;

          // If both reported the same score, auto-accept
          if (homeReport && awayReport && homeReport === awayReport) {
            await finalizeMatchResult(matchId, homeReport);
            showNotification('‚úÖ Both teams agreed! Score accepted: ' + homeReport);
          } else if (homeReport && awayReport) {
            showNotification('‚ö†Ô∏è Score mismatch! Admin will review.');
          } else {
            showNotification('üì§ Score reported! Waiting for opponent.');
          }
        }
      } catch (e) {
        console.error('Self-report error:', e);
        alert('Error submitting report: ' + e.message);
      }
    }

    // Finalize match result (reuse setScore logic)
    async function finalizeMatchResult(matchId, result) {
      try {
        await db.ref(`matches/${matchId}/result`).set(result);

        const betsSnap = await db.ref('bets').once('value');
        const allBets = betsSnap.val() || {};
        const updates = {};

        for (const [user, userBets] of Object.entries(allBets)) {
          if (userBets[matchId]) {
            const bet = userBets[matchId];
            const [h, a] = result.split('-').map(Number);
            const actual = h > a ? '1' : h < a ? '2' : 'X';
            const win = bet.outcome === actual;
            const payout = win ? bet.stake * bet.odd : bet.stake;
            const profit = payout - bet.stake;
            const userSnap = await db.ref(`users/${user}/credits`).once('value');
            const cur = userSnap.val() || 0;
            updates[`users/${user}/credits`] = cur + payout;
            updates[`history/${user}/${matchId}`] = { ...bet, win, profit, result };
            updates[`bets/${user}/${matchId}`] = null;

            const notifKey = firebase.database().ref(`notifications/${user}`).push().key;
            const match = globalMatches[matchId];
            const notifMsg = win
              ? `‚úÖ WON! ${match.home} vs ${match.away} - Payout: +${payout.toFixed(2)}`
              : `‚ùå LOST! ${match.home} vs ${match.away} - Stake lost: ${bet.stake}`;
            updates[`notifications/${user}/${notifKey}`] = notifMsg;
          }
        }

        if (Object.keys(updates).length > 0) {
          await db.ref().update(updates);
        }

        // Check Parlays
        try {
          await checkParlays(matchId, result);
        } catch (e) { console.error("Parlay check failed", e); }

        // Check bracket progression
        const snap = await db.ref('matches').get();
        checkBracketProgression(snap.val());
      } catch (e) {
        console.error('Finalize result error:', e);
      }
    }

    function deleteMatch(matchId) {
      showConfirm("Delete Match", "Delete this match and rollback all bets?", async () => {
        console.log("Delete confirmed for:", matchId);
        try {
          const betsSnap = await db.ref('bets').once('value');
          const allBets = betsSnap.val() || {};
          const usersSnap = await db.ref('users').once('value');
          const allUsers = usersSnap.val() || {};
          const updates = {};

          for (const [username, userBets] of Object.entries(allBets)) {
            if (userBets[matchId]) {
              const bet = userBets[matchId];
              const cur = allUsers[username] ? (allUsers[username].credits || 0) : 0;
              updates[`users/${username}/credits`] = cur + bet.stake;
              updates[`bets/${username}/${matchId}`] = null;
            }
          }
          updates[`matches/${matchId}`] = null;

          await db.ref().update(updates);
          console.log("Delete successful");
        } catch (e) {
          console.error("Delete failed:", e);
          alert("Error deleting match: " + e.message);
        }
      });
    }

    // --- USER MGMT ---
    async function createUser() {
      const u = document.getElementById('uName').value.trim();
      const p = document.getElementById('uPass').value.trim();
      const c = parseInt(document.getElementById('uCred').value);

      if (!u || !p || isNaN(c)) return alert("Please fill all fields.");

      const snap = await db.ref(`users/${u}`).once('value');
      if (snap.exists()) return alert("User already exists!");

      await db.ref(`users/${u}`).set({ pass: p, credits: c });
      alert(`User ${u} created!`);
      // Clear
      document.getElementById('uName').value = '';
      document.getElementById('uPass').value = '';
      document.getElementById('uCred').value = '';
    }

    function deleteUser(user) {
      showConfirm("Delete User", `DELETE User ${user}? This will wipe their bets and history.`, async () => {
        const updates = {};
        updates[`users/${user}`] = null;
        updates[`bets/${user}`] = null;
        updates[`history/${user}`] = null;
        updates[`notifications/${user}`] = null;
        await db.ref().update(updates);
      });
    }

    function setCredits(user) {
      showPrompt("Set Credits", `Set NEW CREDIT BALANCE for ${user}:`, async (amount) => {
        if (!amount || isNaN(amount)) return;
        const val = parseInt(amount);
        await db.ref(`users/${user}/credits`).set(val);
      });
    }

    // --- RENDERERS ---
    function updateDropdowns(teams) {
      const opts = teams.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
      document.getElementById('gmHome').innerHTML = opts;
      document.getElementById('gmAway').innerHTML = opts;
      const brOpts = '<option value="">--</option>' + opts;
      // Semi-Final dropdowns
      ['brSF1H', 'brSF1A', 'brSF2H', 'brSF2A'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = brOpts;
      });
      // Quarter-Final dropdowns
      ['brQF1H', 'brQF1A', 'brQF2H', 'brQF2A', 'brQF3H', 'brQF3A', 'brQF4H', 'brQF4A'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = brOpts;
      });
    }

    function updateBracketStageUI() {
      const stageType = document.getElementById('stageType').value;
      const sfPairings = document.querySelectorAll('.sf-pairing');
      const qfPairings = document.querySelectorAll('.qf-pairing');

      if (stageType === 'QF') {
        // Show Quarter-Finals, hide Semi-Finals
        sfPairings.forEach(el => el.style.display = 'none');
        qfPairings.forEach(el => el.style.display = 'block');
      } else {
        // Show Semi-Finals, hide Quarter-Finals
        sfPairings.forEach(el => el.style.display = 'block');
        qfPairings.forEach(el => el.style.display = 'none');
      }
    }

    function renderAdminMatches(matches) {
      const html = Object.entries(matches).map(([id, m]) => {
        const isPend = m.pending ? ' (Pending)' : '';

        // Self-report status display
        let selfReportHtml = '';
        if (!m.result && !m.pending && m.selfReports) {
          const homeReport = m.selfReports.home;
          const awayReport = m.selfReports.away;

          if (homeReport && awayReport) {
            if (homeReport === awayReport) {
              selfReportHtml = `<div class="admin-self-reports" style="background:rgba(18,237,128,0.2);">
                <span class="reported">‚úÖ Both agreed: ${homeReport}</span>
              </div>`;
            } else {
              selfReportHtml = `<div class="admin-self-reports" style="background:rgba(255,68,68,0.2);">
                <span class="report-item reported">‚ö†Ô∏è ${m.home}: ${homeReport}</span>
                <span class="report-item reported">${m.away}: ${awayReport}</span>
                <span style="color:#ff4444; font-weight:bold;"> CONFLICT</span>
              </div>`;
            }
          } else {
            selfReportHtml = `<div class="admin-self-reports">
              <span class="report-item ${homeReport ? 'reported' : 'waiting'}">${m.home}: ${homeReport || 'waiting'}</span>
              <span class="report-item ${awayReport ? 'reported' : 'waiting'}">${m.away}: ${awayReport || 'waiting'}</span>
            </div>`;
          }
        }

        return `
      <div style="padding:12px; border-bottom:1px solid #444; ${m.pending ? 'opacity:0.5' : ''}">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
              <span style="font-size:0.85rem">${m.home} vs ${m.away}</span>
              <div style="font-size:0.7rem; color:#888">${m.group ? 'Grp ' + m.group : (m.stage || 'Friend')}${isPend}</div>
          </div>
          <div>
              ${!m.pending ? `<button class="refresh-btn" style="font-size:0.7rem; padding:4px 8px;" onclick="setScore('${id}')">${m.result || 'Set Result'}</button>` : ''}
              <button class="delete-btn" style="margin-left:5px" onclick="deleteMatch('${id}')">X</button>
          </div>
        </div>
        ${selfReportHtml}
      </div>
    `}).join('');
      document.getElementById('admin-match-list').innerHTML = html || 'No matches.';
    }

    function renderBracketView(matches) {
      // Quarter-Finals
      const qf1 = Object.values(matches).filter(m => m.stage === 'QF1');
      const qf2 = Object.values(matches).filter(m => m.stage === 'QF2');
      const qf3 = Object.values(matches).filter(m => m.stage === 'QF3');
      const qf4 = Object.values(matches).filter(m => m.stage === 'QF4');
      const hasQF = qf1.length > 0 || qf2.length > 0 || qf3.length > 0 || qf4.length > 0;

      // Semi-Finals
      const sf1 = Object.values(matches).filter(m => m.stage === 'SF1');
      const sf2 = Object.values(matches).filter(m => m.stage === 'SF2');

      // Finals
      const fin = Object.values(matches).find(m => m.stage === 'FINAL') || { home: 'TBD', away: 'TBD', result: '', pending: true };
      const third = Object.values(matches).find(m => m.stage === '3RD') || { home: 'TBD', away: 'TBD', result: '', pending: true };

      // Get first match from array or create TBD
      const getMatch = (arr) => arr.length > 0 ? arr[0] : { home: 'TBD', away: 'TBD', result: '', pending: true };

      // Helper to render a bracket-style match box (two teams stacked with scores)
      const renderBracketMatch = (m, matchNum = '', accentColor = '#666') => {
        const hasResult = m.result && m.result !== '';
        const isPending = m.pending || m.home === 'TBD';
        const [homeScore, awayScore] = hasResult ? m.result.split('-') : ['', ''];

        // Determine winner for highlighting
        const homeWins = hasResult && parseInt(homeScore) > parseInt(awayScore);
        const awayWins = hasResult && parseInt(awayScore) > parseInt(homeScore);

        return `
          <div style="display: flex; align-items: center;">
            <div style="color: #666; font-size: 0.75rem; width: 20px; text-align: center;">${matchNum}</div>
            <div style="
              background: #3a3a3a;
              border-radius: 4px;
              overflow: hidden;
              min-width: 180px;
              border-left: 3px solid ${accentColor};
            ">
              <!-- Home Team -->
              <div style="
                display: flex;
                align-items: center;
                padding: 8px 10px;
                background: ${homeWins ? 'rgba(255,140,0,0.15)' : '#3a3a3a'};
                border-bottom: 1px solid #2a2a2a;
              ">
                <span style="
                  color: #888;
                  font-size: 0.7rem;
                  width: 18px;
                ">${hasResult ? (homeWins ? '1' : '2') : ''}</span>
                <span style="
                  flex: 1;
                  color: ${isPending ? '#555' : '#fff'};
                  font-size: 0.85rem;
                  font-weight: ${homeWins ? '600' : '400'};
                ">${m.home}</span>
                <span style="
                  background: ${homeWins ? '#ff8c00' : 'transparent'};
                  color: ${homeWins ? '#fff' : '#888'};
                  padding: 2px 8px;
                  border-radius: 3px;
                  font-size: 0.85rem;
                  font-weight: bold;
                  min-width: 25px;
                  text-align: center;
                ">${homeScore || '-'}</span>
              </div>
              <!-- Away Team -->
              <div style="
                display: flex;
                align-items: center;
                padding: 8px 10px;
                background: ${awayWins ? 'rgba(255,140,0,0.15)' : '#3a3a3a'};
              ">
                <span style="
                  color: #888;
                  font-size: 0.7rem;
                  width: 18px;
                ">${hasResult ? (awayWins ? '1' : '2') : ''}</span>
                <span style="
                  flex: 1;
                  color: ${isPending ? '#555' : '#fff'};
                  font-size: 0.85rem;
                  font-weight: ${awayWins ? '600' : '400'};
                ">${m.away}</span>
                <span style="
                  background: ${awayWins ? '#ff8c00' : 'transparent'};
                  color: ${awayWins ? '#fff' : '#888'};
                  padding: 2px 8px;
                  border-radius: 3px;
                  font-size: 0.85rem;
                  font-weight: bold;
                  min-width: 25px;
                  text-align: center;
                ">${awayScore || '-'}</span>
              </div>
            </div>
          </div>
        `;
      };

      const display = document.getElementById('bracket-display');
      const hasBracket = hasQF || sf1.length > 0 || sf2.length > 0 || (fin.home !== 'TBD' && !fin.pending);

      if (!hasBracket) {
        display.innerHTML = `
          <div class="bracket-empty">
            <div style="font-size:3rem; margin-bottom:15px; opacity:0.3;">üèÜ</div>
            <div style="font-size:1.1rem; color:#888;">Tournament bracket not initialized</div>
            <div style="font-size:0.85rem; color:#666; margin-top:8px;">Select teams above to begin</div>
          </div>
        `;
        return;
      }

      // Match box height for calculating connector positions
      const matchHeight = 70; // Approximate height of a match box
      const matchGap = 15;    // Gap between matches

      // Build the bracket using flexbox with proper alignment
      let html = `<div style="display: flex; align-items: flex-start; padding: 20px; overflow-x: auto; gap: 0;">`;

      // QUARTER-FINALS COLUMN (if exists)
      if (hasQF) {
        html += `
          <div style="display: flex; flex-direction: column;">
            <div style="text-align: center; color: #60a5fa; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; padding: 10px 0; border-bottom: 1px solid #444;">Quarter-Finals</div>
            <div style="display: flex; flex-direction: column; gap: ${matchGap}px; padding-top: 15px;">
              ${renderBracketMatch(getMatch(qf1), '1', '#3b82f6')}
              ${renderBracketMatch(getMatch(qf2), '2', '#3b82f6')}
              <div style="height: 20px;"></div>
              ${renderBracketMatch(getMatch(qf3), '3', '#3b82f6')}
              ${renderBracketMatch(getMatch(qf4), '4', '#3b82f6')}
            </div>
          </div>
        `;

        // QF to SF Connectors
        html += `
          <div style="display: flex; flex-direction: column; justify-content: flex-start; padding-top: 50px;">
            <!-- Top pair connector (QF1 & QF2 -> SF1) -->
            <div style="display: flex; flex-direction: column; height: ${matchHeight * 2 + matchGap}px;">
              <div style="flex: 1; border-right: 2px solid #555; border-top: 2px solid #555; margin-left: 0; width: 25px;"></div>
              <div style="width: 25px; border-top: 2px solid #555;"></div>
              <div style="flex: 1; border-right: 2px solid #555; border-bottom: 2px solid #555; margin-left: 0; width: 25px;"></div>
            </div>
            <div style="height: 40px;"></div>
            <!-- Bottom pair connector (QF3 & QF4 -> SF2) -->
            <div style="display: flex; flex-direction: column; height: ${matchHeight * 2 + matchGap}px;">
              <div style="flex: 1; border-right: 2px solid #555; border-top: 2px solid #555; margin-left: 0; width: 25px;"></div>
              <div style="width: 25px; border-top: 2px solid #555;"></div>
              <div style="flex: 1; border-right: 2px solid #555; border-bottom: 2px solid #555; margin-left: 0; width: 25px;"></div>
            </div>
          </div>
        `;
      }

      // SEMI-FINALS COLUMN
      const sfTopPadding = hasQF ? (matchHeight / 2 + matchGap / 2) : 0;
      html += `
        <div style="display: flex; flex-direction: column;">
          <div style="text-align: center; color: var(--b365-accent-yellow); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; padding: 10px 0; border-bottom: 1px solid #444;">Semifinals</div>
          <div style="display: flex; flex-direction: column; padding-top: ${hasQF ? 15 + sfTopPadding : 15}px; gap: ${hasQF ? matchHeight + matchGap + 40 : 60}px;">
            ${renderBracketMatch(getMatch(sf1), '1', '#ffd71b')}
            ${renderBracketMatch(getMatch(sf2), '2', '#ffd71b')}
          </div>
        </div>
      `;

      // SF to Final Connector
      const sfConnectorHeight = hasQF ? (matchHeight * 2 + matchGap * 2 + 40) : (matchHeight + 60);
      html += `
        <div style="display: flex; flex-direction: column; justify-content: flex-start; padding-top: ${hasQF ? 50 + sfTopPadding : 50}px;">
          <div style="display: flex; flex-direction: column; height: ${sfConnectorHeight}px;">
            <div style="flex: 1; border-right: 2px solid #555; border-top: 2px solid #555; width: 25px;"></div>
            <div style="width: 25px; border-top: 2px solid #555;"></div>
            <div style="flex: 1; border-right: 2px solid #555; border-bottom: 2px solid #555; width: 25px;"></div>
          </div>
        </div>
      `;

      // FINALS COLUMN
      const finalTopPadding = hasQF ? (matchHeight * 1.5 + matchGap + 20) : (matchHeight / 2 + 30);
      html += `
        <div style="display: flex; flex-direction: column;">
          <div style="text-align: center; color: var(--b365-bright-green); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; padding: 10px 0; border-bottom: 1px solid #444;">Finals</div>
          <div style="display: flex; flex-direction: column; padding-top: ${15 + finalTopPadding}px; gap: 25px;">
            ${renderBracketMatch(fin, 'üèÜ', 'var(--b365-bright-green)')}
            <div style="opacity: 0.6; margin-top: 15px;">
              ${renderBracketMatch(third, '3rd', '#666')}
            </div>
          </div>
        </div>
      `;

      html += `</div>`;
      display.innerHTML = html;
    }

    function renderAdminUserList(users) {
      if (!users) return;
      const html = `<table>
        <tr><th>User / Team</th><th>Credits</th><th>GF</th><th>GA</th><th>Action</th></tr>
        ${Object.entries(users).map(([key, u]) => {
        const stats = globalTeamStats[key] || { gf: 0, ga: 0 };
        return `<tr>
                <td>${key}</td>
                <td style="color:var(--b365-bright-green)">${u.credits}</td>
                <td>${stats.gf}</td>
                <td>${stats.ga}</td>
                <td>
                  <button class="small-btn" onclick="setCredits('${key}')">Set</button>
                  <button class="small-btn" style="background:transparent; color:#ff4444;" onclick="deleteUser('${key}')">X</button>
                </td>
            </tr>`;
      }).join('')}
      </table>`;
      document.getElementById('user-list-admin').innerHTML = html;
    }

    function renderActiveBets(bets, matches) {
      if (!bets) { document.getElementById('admin-active-bets').innerHTML = 'No bets.'; return; }
      let html = '<table style="font-size:0.85rem">';
      html += '<tr><th>User</th><th>Match</th><th>Pick</th><th>Stake</th></tr>';

      Object.entries(bets).forEach(([user, userBets]) => {
        Object.entries(userBets).forEach(([mId, b]) => {
          const m = matches[mId];
          const mName = m ? `${m.home} v ${m.away}` : mId;
          const status = b.resolved ? (b.win ? '‚úÖ' : '‚ùå') : '‚è≥';

          html += `<tr>
                <td>${user}</td>
                <td>${mName}</td>
                <td>${b.outcome}</td>
                <td>${b.stake} ${status}</td>
             </tr>`;
        });
      });
      html += '</table>';
      document.getElementById('admin-active-bets').innerHTML = html;
    }

    function renderAdminBetHistory(history, parlays, matches) {
      let items = [];
      if (history) {
        Object.entries(history).forEach(([user, userHistory]) => {
          Object.entries(userHistory).forEach(([mId, h]) => {
            const m = matches[mId] || { home: 'Unknown', away: 'Unknown' };
            items.push({ ...h, type: 'single', user, mName: `${m.home} v ${m.away}`, id: mId });
          });
        });
      }
      if (parlays) {
        Object.entries(parlays).forEach(([user, userParlays]) => {
          Object.entries(userParlays).forEach(([pId, p]) => {
            // Only show settled outcomes in history
            if (p.status === 'won' || p.status === 'lost') {
              items.push({ ...p, type: 'parlay', user, id: pId, win: p.status === 'won' });
            }
          });
        });
      }

      if (items.length === 0) { document.getElementById('admin-bet-history').innerHTML = 'No history.'; return; }

      // Sort by roughly timestamp if available, else random
      // Singles don't have timestamp stored historically (oops), but new parlays do.
      // We'll just display them.

      let html = '<table style="font-size:0.85rem; width:100%; border-collapse:collapse;">';
      html += '<tr><th>User</th><th>Type/Match</th><th>Pick</th><th>Stake</th><th>Profit</th></tr>';

      items.forEach((item, idx) => {
        const isParlay = item.type === 'parlay';
        const bg = item.win ? 'rgba(0,255,0,0.1)' : 'rgba(255,0,0,0.1)';
        if (!isParlay) {
          html += `<tr style="background:${bg}">
                <td>${item.user}</td>
                <td>${item.mName}</td>
                <td>${item.outcome}</td>
                <td>${item.stake}</td>
                <td>${item.profit}</td>
             </tr>`;
        } else {
          // Parlay Row
          const profit = item.win ? (item.stake * item.totalOdds - item.stake).toFixed(2) : -item.stake;
          html += `<tr style="background:${bg}; cursor:pointer; border-bottom:1px dashed #555;" onclick="toggleDetails('hist_${idx}')">
                <td>${item.user}</td>
                <td><strong>Parlay (${item.legs.length} legs)</strong> <span style="font-size:0.7em">‚ñº</span></td>
                <td>-</td>
                <td>${item.stake}</td>
                <td>${profit}</td>
             </tr>`;

          // Details Row
          const legsHtml = item.legs.map(l => {
            const m = matches[l.matchId] || { home: '?', away: '?' };
            // Determine leg status if known
            // We don't store leg status persistently in parlay object easily unless we updated it. 
            // But we can check globalMatches result.
            let status = '‚è≥';
            if (m.result) {
              const [h, a] = m.result.split('-').map(Number);
              const actual = h > a ? '1' : h < a ? '2' : 'X';
              status = actual === l.outcome ? '‚úÖ' : '‚ùå';
            }
            return `<div>${m.home} v ${m.away} [${l.outcome}] (${l.odd}) ${status}</div>`;
          }).join('');

          html += `<tr id="hist_${idx}" style="display:none; background:#222;">
                <td colspan="5" style="padding:10px; font-size:0.8rem; color:#ccc;">
                    ${legsHtml}
                    <div style="margin-top:5px; font-weight:bold;">Total Odds: ${item.totalOdds}</div>
                </td>
             </tr>`;
        }
      });

      html += '</table>';
      document.getElementById('admin-bet-history').innerHTML = html;
    }

    function renderUserBetHistory(history, parlays, matches) {
      let items = [];
      if (history) {
        Object.entries(history).forEach(([mId, h]) => {
          const m = matches[mId] || { home: 'Unknown', away: 'Unknown' };
          items.push({ ...h, type: 'single', mName: `${m.home} v ${m.away}`, id: mId });
        });
      }
      if (parlays) {
        Object.values(parlays).forEach(p => {
          if (p.status === 'won' || p.status === 'lost') {
            items.push({ ...p, type: 'parlay', win: p.status === 'won' });
          }
        });
      }

      if (items.length === 0) { document.getElementById('user-bet-history').innerHTML = 'No history.'; return; }

      let html = '<table style="font-size:0.85rem; width:100%; border-collapse:collapse;">';
      html += '<tr><th>Match/Type</th><th>Pick</th><th>Stake</th><th>Profit</th></tr>';

      items.forEach((item, idx) => {
        const isParlay = item.type === 'parlay';
        const bg = item.win ? 'rgba(0,255,0,0.1)' : 'rgba(255,0,0,0.1)';

        if (!isParlay) {
          html += `<tr style="background:${bg}">
                <td>${item.mName}</td>
                <td>${item.outcome}</td>
                <td>${item.stake}</td>
                <td>${item.profit}</td>
              </tr>`;
        } else {
          const profit = item.win ? (item.stake * item.totalOdds - item.stake).toFixed(2) : -item.stake;
          html += `<tr style="background:${bg}; cursor:pointer; border-bottom:1px dashed #555;" onclick="toggleDetails('uhist_${idx}')">
                <td><strong>Parlay (${item.legs.length} legs)</strong> <span style="font-size:0.7em">‚ñº</span></td>
                <td>-</td>
                <td>${item.stake}</td>
                <td>${profit}</td>
             </tr>`;

          const legsHtml = item.legs.map(l => {
            const m = matches[l.matchId] || { home: '?', away: '?' };
            let status = '‚è≥';
            if (m.result) {
              const [h, a] = m.result.split('-').map(Number);
              const actual = h > a ? '1' : h < a ? '2' : 'X';
              status = actual === l.outcome ? '‚úÖ' : '‚ùå';
            }
            return `<div>${m.home} v ${m.away} [${l.outcome}] (${l.odd}) ${status}</div>`;
          }).join('');

          html += `<tr id="uhist_${idx}" style="display:none; background:#222;">
                <td colspan="4" style="padding:10px; font-size:0.8rem; color:#ccc;">
                    ${legsHtml}
                    <div style="margin-top:5px; font-weight:bold;">Total Odds: ${item.totalOdds}</div>
                </td>
             </tr>`;
        }
      });
      html += '</table>';
      document.getElementById('user-bet-history').innerHTML = html;
    }

    function toggleDetails(id) {
      const el = document.getElementById(id);
      if (el) el.style.display = el.style.display === 'none' ? 'table-row' : 'none';
    }

    function renderActiveParlays(parlays, matches) {
      // Render pending parlays in Admin view, possibly appended to active bets or checking if tab structure exists
      // For now, let's just create a simplified list if the container exists, or append to admin-active-bets
      const container = document.getElementById('admin-active-bets');
      if (!container) return;

      // We will append to existing innerHTML? No, active bets render function wipes it.
      // We need to call renderActiveBets AND renderActiveParlays together or have one call the other.
      // I'll leave this empty for now and merge logic in renderActiveBets if needed, 
      // but the prompt asked for HISTORY to be expandable. 
      // I will focus on history compliance first. Active bets visualization wasn't explicitly "expandable active bets", 
      // but "bets" in general.

      // Actually, let's make a container for active parlays.
    }

    function showNotification(msg) {
      const div = document.createElement('div');
      div.style = 'background:var(--b365-bright-green); color:#000; padding:10px; margin-bottom:10px; border-radius:4px;';
      div.textContent = msg;
      document.getElementById('notifications').appendChild(div);
      setTimeout(() => div.remove(), 5000);
    }

    function renderAnalytics(history) {
      if (!history) { document.getElementById('analytics-dashboard').innerHTML = 'No data.'; return; }
      let totalBets = 0, totalWins = 0, totalProfit = 0;
      Object.entries(history).forEach(([user, userHistory]) => {
        Object.entries(userHistory).forEach(([mId, h]) => {
          totalBets++;
          if (h.win) totalWins++;
          totalProfit += h.profit;
        });
      });
      const html = `
      <p>Total Bets: ${totalBets}</p>
      <p>Total Wins: ${totalWins}</p>
      <p>Total Profit: ${totalProfit}</p>
    `;
      document.getElementById('analytics-dashboard').innerHTML = html;
    }

    function renderUserOdds(matches) {
      const html = Object.entries(matches)
        .filter(([id, m]) => !m.result && !m.pending) // Hide Pending (Bracket placeholders)
        .map(([id, m]) => `
      <div class="match-row">
        <div>
            <div style="font-weight:bold">${m.home}</div>
            <div style="font-weight:bold">${m.away}</div>
            <div style="font-size:0.7rem; color:#888">${m.stage || 'Group ' + (m.group || 'Match')}</div>
        </div>
        <div class="odds-group">
          <div class="odd-box" onclick="addToSlip('${id}', '1', ${m.odds['1']})"><span class="odd-lbl">1</span><span class="odd-val">${m.odds['1']}</span></div>
          <div class="odd-box" onclick="addToSlip('${id}', 'X', ${m.odds['X']})"><span class="odd-lbl">X</span><span class="odd-val">${m.odds['X']}</span></div>
          <div class="odd-box" onclick="addToSlip('${id}', '2', ${m.odds['2']})"><span class="odd-lbl">2</span><span class="odd-val">${m.odds['2']}</span></div>
        </div>
      </div>
    `).join('');
      document.getElementById('user-betting-odds').innerHTML = html || '<div style="padding:20px; color:#888;">No active markets.</div>';
    }

    async function updateStandings(teams, matches) {
      const stats = {};
      // Init stats
      teams.forEach(t => {
        stats[t.id] = { p: 0, gd: 0, gf: 0, ga: 0 };
        globalTeamStats[t.name] = { gf: 0, ga: 0 };
      });

      Object.values(matches).forEach(m => {
        if (!m.result) return;
        // SKIP Playoffs for Points
        if (m.stage && ['SF1', 'SF2', 'FINAL', '3RD'].includes(m.stage)) return;

        const [hG, aG] = m.result.split('-').map(Number);
        if (!stats[m.homeId]) stats[m.homeId] = { p: 0, gd: 0, gf: 0, ga: 0 };
        if (!stats[m.awayId]) stats[m.awayId] = { p: 0, gd: 0, gf: 0, ga: 0 };

        stats[m.homeId].gf += hG; stats[m.homeId].ga += aG;
        stats[m.awayId].gf += aG; stats[m.awayId].ga += hG;
        stats[m.homeId].gd += (hG - aG); stats[m.awayId].gd += (aG - hG);

        if (hG > aG) stats[m.homeId].p += 3; else if (aG > hG) stats[m.awayId].p += 3; else { stats[m.homeId].p += 1; stats[m.awayId].p += 1; }

        // Global stats (GF/GA) DO include playoffs? Usually total stats do, but prompt said "do not add points to the group table".
        // I will update globalTeamStats here just for the User Management view.
        if (m.home) globalTeamStats[m.home] = { gf: stats[m.homeId].gf, ga: stats[m.homeId].ga };
        if (m.away) globalTeamStats[m.away] = { gf: stats[m.awayId].gf, ga: stats[m.awayId].ga };
      });

      const groups = ['A', 'B', 'C', 'D', 'E'];
      const groupColors = {
        'A': { bg: '#1a2744', border: '#3b82f6', header: 'linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%)' },
        'B': { bg: '#2d1f3d', border: '#a855f7', header: 'linear-gradient(135deg, #9333ea 0%, #7c3aed 100%)' },
        'C': { bg: '#1a2f1a', border: '#22c55e', header: 'linear-gradient(135deg, #16a34a 0%, #15803d 100%)' },
        'D': { bg: '#2d2a1a', border: '#f59e0b', header: 'linear-gradient(135deg, #d97706 0%, #b45309 100%)' },
        'E': { bg: '#1e3a5f', border: '#06b6d4', header: 'linear-gradient(135deg, #0891b2 0%, #0e7490 100%)' }
      };

      document.getElementById('standings-area').innerHTML = groups.map(g => {
        const gTeams = teams.filter(t => t.group === g).map(t => ({ n: t.name, ...stats[t.id] || { p: 0, gd: 0, gf: 0, ga: 0 } })).sort((a, b) => b.p - a.p || b.gd - a.gd);
        if (gTeams.length === 0) return '';

        const colors = groupColors[g];

        return `
          <div class="card" style="
            background: linear-gradient(145deg, ${colors.bg} 0%, #0d1117 100%);
            border: 2px solid ${colors.border}40;
            border-radius: 12px;
            overflow: hidden;
          ">
            <div class="card-header" style="
              background: ${colors.header};
              padding: 14px 18px;
              display: flex;
              align-items: center;
              gap: 10px;
              border-bottom: 2px solid ${colors.border}80;
            ">
              <span style="
                width: 32px;
                height: 32px;
                background: rgba(255,255,255,0.2);
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 1.1rem;
              ">${g}</span>
              <div>
                <div style="font-weight: 700; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 1px; color: #fff;">Group ${g}</div>
                <div style="font-size: 0.7rem; color: rgba(255,255,255,0.6);">${gTeams.length} teams</div>
              </div>
            </div>
            <div style="padding: 12px;">
              <table style="width: 100%; border-collapse: separate; border-spacing: 0 6px;">
                <thead>
                  <tr style="font-size: 0.7rem; color: #888; text-transform: uppercase;">
                    <th style="padding: 8px 10px; text-align: left;">#</th>
                    <th style="padding: 8px 10px; text-align: left;">Team</th>
                    <th style="padding: 8px 10px; text-align: center;">Pts</th>
                    <th style="padding: 8px 10px; text-align: center;">GD</th>
                  </tr>
                </thead>
                <tbody>
                  ${gTeams.map((t, idx) => {
          const positionBg = idx === 0 ? 'rgba(34, 197, 94, 0.2)' :
            idx === 1 ? 'rgba(59, 130, 246, 0.15)' :
              'rgba(255,255,255,0.03)';
          const positionColor = idx === 0 ? '#22c55e' :
            idx === 1 ? '#3b82f6' :
              '#888';
          const gdColor = t.gd > 0 ? '#22c55e' : t.gd < 0 ? '#ef4444' : '#888';

          return `
                      <tr style="background: ${positionBg}; border-radius: 8px;">
                        <td style="padding: 10px; border-radius: 8px 0 0 8px; font-weight: bold; color: ${positionColor}; width: 30px;">${idx + 1}</td>
                        <td style="padding: 10px; font-weight: 600;">${t.n}</td>
                        <td style="padding: 10px; text-align: center;">
                          <span style="
                            background: rgba(255,215,27,0.2);
                            color: var(--b365-accent-yellow);
                            padding: 4px 10px;
                            border-radius: 12px;
                            font-weight: bold;
                            font-size: 0.85rem;
                          ">${t.p}</span>
                        </td>
                        <td style="padding: 10px; text-align: center; border-radius: 0 8px 8px 0; color: ${gdColor}; font-size: 0.85rem; font-weight: 500;">
                          ${t.gd > 0 ? '+' : ''}${t.gd}
                        </td>
                      </tr>
                    `;
        }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderAdminTeamsTable(teams) {
      const groups = ['A', 'B', 'C', 'D', 'E'];
      const html = teams.map(t => {
        // Ensure history is array and has exactly 5 entries
        let hist = Array.isArray(t.history) ? [...t.history] : Object.values(t.history || {});
        while (hist.length < 5) hist.push('-');
        hist = hist.slice(0, 5);

        const str = calcStrength(hist).toFixed(2);
        const histInputs = hist.map((val, i) =>
          `<input class="hist-input" value="${val}" onfocus="this.select()" onchange="updateHistory('${t.id}', ${i}, this.value)">`
        ).join('');

        const grpSelect = `<select style="margin:0; padding:4px; width:auto;" onchange="updateTeamData('${t.id}', 'group', this.value)">${groups.map(g => `<option value="${g}" ${t.group === g ? 'selected' : ''}>${g}</option>`).join('')}</select>`;
        return `<tr>
        <td><strong>${t.name}</strong></td>
        <td>${grpSelect}</td>
        <td style="white-space:nowrap">${histInputs}</td>
        <td style="color:var(--b365-accent-yellow); font-weight:bold;">${str}</td>
        <td><button onclick="deleteTeam('${t.id}')" style="background:transparent; color:#ff4444; border:none; cursor:pointer;">X</button></td>
      </tr>`;
      }).join('');
      document.getElementById('admin-teams-body').innerHTML = html || '<tr><td colspan="5" style="text-align:center; padding:15px; color:#888;">No teams registered.</td></tr>';
    }

    function toggleBetSlip() {
      const slip = document.getElementById('bet-slip');
      if (slip) {
        slip.classList.toggle('minimized');
      }
    }

    function addToSlip(matchId, outcome, odd) {
      const m = globalMatches[matchId];
      if (m.home === currentUser && outcome !== '1') return alert('You can only bet on your team to win.');
      if (m.away === currentUser && outcome !== '2') return alert('You can only bet on your team to win.');
      betSlip.push({ matchId, outcome, odd });

      // Auto-expand when adding
      const slip = document.getElementById('bet-slip');
      if (slip) slip.classList.remove('minimized');

      updateBetSlip();
    }

    function updateSlipPotential() {
      const stakeInput = document.getElementById('slip-stake');
      const potentialValue = document.getElementById('slip-potential-value');

      if (!stakeInput || !potentialValue) return;

      const stake = parseFloat(stakeInput.value) || 0;
      const isParlay = document.getElementById('is-parlay') && document.getElementById('is-parlay').checked;
      const totalOdds = betSlip.reduce((acc, item) => acc * parseFloat(item.odd), 1);

      const potential = (isParlay || betSlip.length === 1) ? (stake * totalOdds) : (stake * betSlip.length);
      potentialValue.textContent = `$${potential.toFixed(2)}`;
    }

    function updateBetSlip() {
      const itemsDiv = document.getElementById('slip-items');
      const container = document.getElementById('bet-slip');
      const countBadge = document.getElementById('slip-count');

      // Update count badge
      if (countBadge) countBadge.textContent = betSlip.length;

      // Visibility Control
      if (betSlip.length > 0) {
        container.classList.add('show');
      } else {
        container.classList.remove('show');
        container.classList.remove('minimized'); // Reset state when cleared
      }

      // Render bet items with modern styling
      if (betSlip.length === 0) {
        itemsDiv.innerHTML = `
          <div style="text-align:center; padding:20px; color:#666;">
            <div style="font-size:2rem; margin-bottom:10px; opacity:0.5;">üéØ</div>
            <div>Click on odds to add selections</div>
          </div>
        `;
      } else {
        itemsDiv.innerHTML = betSlip.map((item, index) => {
          const m = globalMatches[item.matchId];
          const outcomeLabel = item.outcome === '1' ? m.home : item.outcome === '2' ? m.away : 'Draw';
          return `
            <div style="
              background: rgba(255,255,255,0.05);
              border: 1px solid rgba(255,255,255,0.1);
              border-radius: 10px;
              padding: 12px 15px;
              margin-bottom: 10px;
              position: relative;
            ">
              <button onclick="removeFromSlip(${index})" style="
                position: absolute;
                top: 8px;
                right: 8px;
                background: rgba(255,68,68,0.2);
                border: none;
                color: #ff6666;
                width: 24px;
                height: 24px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 14px;
                line-height: 1;
                transition: all 0.2s;
              " onmouseover="this.style.background='rgba(255,68,68,0.4)'" onmouseout="this.style.background='rgba(255,68,68,0.2)'">&times;</button>
              <div style="font-size:0.75rem; color:#888; text-transform:uppercase; margin-bottom:4px;">${m.stage || 'Group ' + (m.group || 'Match')}</div>
              <div style="font-weight:600; margin-bottom:6px; padding-right:25px;">${m.home} vs ${m.away}</div>
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="
                  background: var(--b365-dark-green);
                  color: white;
                  padding: 4px 10px;
                  border-radius: 4px;
                  font-size: 0.8rem;
                  font-weight: bold;
                ">${outcomeLabel}</span>
                <span style="color:var(--b365-accent-yellow); font-weight:bold; font-size:1.1rem;">${item.odd}</span>
              </div>
            </div>
          `;
        }).join('');
      }

      const isParlay = document.getElementById('is-parlay') && document.getElementById('is-parlay').checked;
      const totalOdds = betSlip.reduce((acc, item) => acc * parseFloat(item.odd), 1);

      // Update potential win display efficiently
      updateSlipPotential();

      // Add input listener for real-time potential calculation
      const stakeInput = document.getElementById('slip-stake');
      if (stakeInput && !stakeInput.hasAttribute('data-listener-attached')) {
        stakeInput.setAttribute('data-listener-attached', 'true');
        stakeInput.addEventListener('input', updateSlipPotential);
      }

      let summaryHtml = '';
      if (betSlip.length > 1) {
        summaryHtml = `
          <div style="padding:15px 0; border-bottom:1px solid rgba(255,255,255,0.1);">
            <label style="
              display:flex; 
              align-items:center; 
              gap:12px; 
              cursor:pointer;
              padding: 12px 15px;
              background: ${isParlay ? 'rgba(18, 237, 128, 0.15)' : 'rgba(255,255,255,0.05)'};
              border: 2px solid ${isParlay ? 'var(--b365-bright-green)' : 'transparent'};
              border-radius: 10px;
              transition: all 0.2s;
            ">
              <input type="checkbox" id="is-parlay" onchange="updateBetSlip()" ${isParlay ? 'checked' : ''} 
                style="width:20px; height:20px; accent-color: var(--b365-bright-green);">
              <div style="flex:1;">
                <div style="font-weight:600;">Combine as Parlay</div>
                <div style="font-size:0.8rem; color:#888;">All selections must win</div>
              </div>
              <div style="text-align:right;">
                <div style="color:var(--b365-accent-yellow); font-weight:bold; font-size:1.2rem;">x${totalOdds.toFixed(2)}</div>
                <div style="font-size:0.7rem; color:#888;">Combined Odds</div>
              </div>
            </label>
          </div>
        `;
      }

      document.getElementById('slip-extras').innerHTML = summaryHtml;
    }

    function removeFromSlip(index) {
      betSlip.splice(index, 1);
      updateBetSlip();
    }

    async function placeBetsFromSlip() {
      const stake = parseFloat(document.getElementById('slip-stake').value);
      if (isNaN(stake) || stake <= 0) return alert('Invalid stake');

      const isParlay = document.getElementById('is-parlay') && document.getElementById('is-parlay').checked && betSlip.length > 1;

      const balanceSnap = await db.ref(`users/${currentUser}/credits`).once('value');
      const balance = balanceSnap.val() || 0;

      const totalStake = isParlay ? stake : stake * betSlip.length;

      if (totalStake > balance) return alert('Insufficient balance (Cost: ' + totalStake + ')');

      // Validation for Parlay (No same match)
      if (isParlay) {
        const mids = new Set(betSlip.map(i => i.matchId));
        if (mids.size !== betSlip.length) return alert("Parlay cannot contain multiple outcomes for the same match.");
      }

      const updates = {};
      updates[`users/${currentUser}/credits`] = balance - totalStake;

      if (isParlay) {
        const totalOdds = betSlip.reduce((acc, item) => acc * parseFloat(item.odd), 1).toFixed(2);
        const parlayId = 'p_' + Date.now();
        updates[`parlays/${currentUser}/${parlayId}`] = {
          stake: stake,
          totalOdds: totalOdds,
          legs: betSlip,
          status: 'pending', // pending, won, lost
          timestamp: Date.now()
        };
      } else {
        betSlip.forEach(item => {
          updates[`bets/${currentUser}/${item.matchId}`] = { outcome: item.outcome, stake, odd: item.odd };
        });
      }

      await db.ref().update(updates);
      betSlip = [];
      updateBetSlip();
      showNotification(isParlay ? 'Parlay Placed!' : 'Bets Placed!');
    }

    async function checkParlays(matchId, score) {
      // This function checks ALL active parlays to see if they are affected by this match result
      const snap = await db.ref('parlays').once('value');
      const allParlays = snap.val() || {};
      const updates = {};

      const [h, a] = score.split('-').map(Number);
      const actual = h > a ? '1' : h < a ? '2' : 'X';

      // Loop users
      for (const [user, userParlays] of Object.entries(allParlays)) {
        for (const [pId, parlay] of Object.entries(userParlays)) {
          if (parlay.status !== 'pending') continue;

          // Does this parlay contain this match?
          const legIndex = parlay.legs.findIndex(l => l.matchId === matchId);
          if (legIndex === -1) continue; // Not relevant

          // Check if this leg lost
          const leg = parlay.legs[legIndex];
          if (leg.outcome !== actual) {
            updates[`parlays/${user}/${pId}/status`] = 'lost';
            updates[`parlays/${user}/${pId}/lossMatch`] = matchId; // Track which match killed it
            updates[`parlays/${user}/${pId}/settledAt`] = Date.now();

            const notifKey = firebase.database().ref(`notifications/${user}`).push().key;
            updates[`notifications/${user}/${notifKey}`] = `‚ùå PARLAY LOST! Failed on ${globalMatches[matchId].home} vs ${globalMatches[matchId].away} - Stake lost: ${parlay.stake}`;
            continue; // Parlay dead
          }

          // If leg won, we need to check if ALL legs are now won
          // We need to fetch current results for all other legs to be sure, 
          // OR we can trust that 'pending' means we verify on every relevant update.
          // Better: Verify all legs now.
          let allWon = true;
          for (const l of parlay.legs) {
            if (l.matchId === matchId) continue; // We know this one won
            const m = globalMatches[l.matchId];
            if (!m || !m.result) {
              allWon = false; break;
            }
            const [lh, la] = m.result.split('-').map(Number);
            const lActual = lh > la ? '1' : lh < la ? '2' : 'X';
            if (l.outcome !== lActual) {
              // This case implies a previous match was updated but parlay wasn't? 
              // Should have been caught. Assume lost.
              updates[`parlays/${user}/${pId}/status`] = 'lost';
              allWon = false; break;
            }
          }

          if (allWon) {
            updates[`parlays/${user}/${pId}/status`] = 'won';
            updates[`parlays/${user}/${pId}/settledAt`] = Date.now();
            const payout = parlay.stake * parlay.totalOdds;

            // Fetch user creds again in case multiple updates
            // We can't do await here inside sync loop comfortably without careful batching, 
            // but we can trust the previous read or just do a transaction. 
            // Simple path: read updates from 'updates' obj if present? No.
            // Just push a credit update.
            const userSnap = await db.ref(`users/${user}/credits`).once('value');
            let cur = userSnap.val() || 0;
            // If we already have a credit update for this user in `updates`, use it
            if (updates[`users/${user}/credits`]) cur = updates[`users/${user}/credits`];

            updates[`users/${user}/credits`] = cur + payout;

            const notifKey = firebase.database().ref(`notifications/${user}`).push().key;
            updates[`notifications/${user}/${notifKey}`] = `üéâ PARLAY WON! All legs correct - Payout: +${payout.toFixed(2)}`;
          }
        }
      }

      await db.ref().update(updates);
    }

    // =====================================================
    // OUTRIGHT WINNER BETTING FUNCTIONS
    // =====================================================

    // Admin: Toggle the outright market open/closed
    async function toggleOutrightMarket(open) {
      await db.ref('outright_market/open').set(open);
      showNotification(open ? 'Outright market is now OPEN!' : 'Outright market is now CLOSED.');
    }

    // Admin: Update the market status badge
    function updateOutrightMarketStatus() {
      const badge = document.getElementById('outright-market-status');
      if (!badge) return;
      if (outrightMarket.open) {
        badge.textContent = 'OPEN';
        badge.className = 'status-badge open';
      } else {
        badge.textContent = 'CLOSED';
        badge.className = 'status-badge closed';
      }
      // Update admin close time display
      updateAdminCloseTimeDisplay();
    }

    // Admin: Set auto-close time
    async function setOutrightCloseTime() {
      const input = document.getElementById('outright-close-time');
      if (!input || !input.value) return alert('Please select a date and time.');

      const closeTime = new Date(input.value).getTime();
      if (closeTime <= Date.now()) return alert('Please select a future time.');

      await db.ref('outright_market/closeTime').set(closeTime);
      showNotification('Auto-close timer set successfully!');
    }

    // Admin: Clear auto-close time
    async function clearOutrightCloseTime() {
      await db.ref('outright_market/closeTime').remove();
      showNotification('Auto-close timer cleared.');
    }

    // Admin: Display current close time
    function updateAdminCloseTimeDisplay() {
      const display = document.getElementById('admin-close-time-display');
      if (!display) return;

      if (outrightMarket.closeTime) {
        const closeDate = new Date(outrightMarket.closeTime);
        display.innerHTML = `‚è∞ Closes: <strong>${closeDate.toLocaleString()}</strong>`;

        // Pre-fill the input
        const input = document.getElementById('outright-close-time');
        if (input) {
          const isoString = new Date(outrightMarket.closeTime - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
          input.value = isoString;
        }
      } else {
        display.innerHTML = 'No auto-close timer set';
      }
    }

    // Countdown timer interval
    let outrightCountdownInterval = null;

    // Start countdown for users
    function startOutrightCountdown() {
      // Clear existing interval
      if (outrightCountdownInterval) {
        clearInterval(outrightCountdownInterval);
      }

      const updateCountdown = () => {
        const display = document.getElementById('user-outright-countdown');
        if (!display) return;

        if (!outrightMarket.closeTime || !outrightMarket.open) {
          display.textContent = '';
          return;
        }

        const now = Date.now();
        const remaining = outrightMarket.closeTime - now;

        if (remaining <= 0) {
          display.textContent = '‚è∞ Closing...';
          // Auto-close will be handled by checkOutrightAutoClose
          return;
        }

        // Format countdown
        const days = Math.floor(remaining / (1000 * 60 * 60 * 24));
        const hours = Math.floor((remaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((remaining % (1000 * 60)) / 1000);

        let countdownText = '‚è∞ ';
        if (days > 0) countdownText += `${days}d `;
        if (hours > 0 || days > 0) countdownText += `${hours}h `;
        countdownText += `${minutes}m ${seconds}s`;

        display.textContent = countdownText;
      };

      // Update immediately and every second
      updateCountdown();
      outrightCountdownInterval = setInterval(updateCountdown, 1000);
    }

    // Check if market should auto-close
    async function checkOutrightAutoClose() {
      if (!outrightMarket.open || !outrightMarket.closeTime) return;

      if (Date.now() >= outrightMarket.closeTime) {
        await db.ref('outright_market/open').set(false);
        showNotification('Outright betting has automatically closed!');
      }
    }

    // Admin: Auto-generate odds based on team strength
    async function autoGenerateOutrightOdds() {
      if (globalTeams.length === 0) return alert('No teams registered!');

      // Calculate strengths (excluding Group E)
      const strengths = globalTeams
        .filter(t => t.group !== 'E')
        .map(t => ({
          id: t.id,
          name: t.name,
          strength: calcStrength(t.history) || 0.5
        }));

      // Find total strength
      const totalStrength = strengths.reduce((sum, t) => sum + t.strength, 0);
      if (totalStrength === 0) return alert('No team strength data available!');

      // Calculate odds (inverse probability with margin)
      const MARGIN = 1.15; // 15% house edge
      const odds = {};

      strengths.forEach(t => {
        const probability = t.strength / totalStrength;
        const rawOdd = (1 / probability) * MARGIN;
        // Clamp odds between 1.10 and 100.00
        odds[t.id] = Math.max(1.10, Math.min(100.00, rawOdd)).toFixed(2);
      });

      await db.ref('outright_market/odds').set(odds);
      showNotification('Outright odds auto-generated based on team strength!');
    }

    // Admin: Update individual team odds
    async function updateOutrightOdds(teamId, odds) {
      const value = parseFloat(odds);
      if (isNaN(value) || value < 1.01) return;
      await db.ref(`outright_market/odds/${teamId}`).set(value.toFixed(2));
    }

    // Admin: Render team rows for setting odds
    function renderAdminOutrightTeams() {
      const container = document.getElementById('admin-outright-teams');
      if (!container) return;

      if (globalTeams.length === 0) {
        container.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">No teams registered</div>';
        return;
      }

      // Exclude Group E teams from outright betting
      const html = globalTeams.filter(t => t.group !== 'E').map(t => {
        const odds = outrightMarket.odds?.[t.id] || '0.00';
        const strength = calcStrength(t.history).toFixed(2);
        return `
          <div class="admin-outright-row">
            <span class="team-name">${t.name}</span>
            <span style="font-size:0.75rem; color:#888;">Group ${t.group} | Str: ${strength}</span>
            <input type="number" step="0.01" min="1.01" value="${odds}" 
                   onchange="updateOutrightOdds('${t.id}', this.value)" 
                   style="background:#222; border-color:#555;" />
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    // Admin: Render active outright bets
    function renderAdminOutrightBets(bets) {
      const container = document.getElementById('admin-outright-bets');
      if (!container) return;

      if (!bets || Object.keys(bets).length === 0) {
        container.innerHTML = '<div style="padding:15px; color:#888;">No outright bets placed.</div>';
        return;
      }

      let html = '<table style="width:100%; font-size:0.85rem;"><tr><th>User</th><th>Team Pick</th><th>Odds</th><th>Stake</th><th>Potential Win</th></tr>';

      Object.entries(bets).forEach(([user, bet]) => {
        const team = globalTeams.find(t => t.id === bet.teamId);
        const teamName = team ? team.name : 'Unknown';
        const potential = (bet.stake * parseFloat(bet.odds)).toFixed(2);
        html += `
          <tr>
            <td>${user}</td>
            <td><strong>${teamName}</strong></td>
            <td style="color:var(--b365-accent-yellow)">${bet.odds}</td>
            <td>${bet.stake}</td>
            <td style="color:var(--b365-bright-green)">${potential}</td>
          </tr>
        `;
      });

      html += '</table>';
      container.innerHTML = html;
    }

    // Admin: Settle the outright market manually or auto-triggered
    async function settleOutrightMarket() {
      // Find the final match and its winner
      const finalMatch = Object.values(globalMatches).find(m => m.stage === 'FINAL');

      if (!finalMatch || !finalMatch.result) {
        return alert('Cannot settle: Final match has not been played yet!');
      }

      const [h, a] = finalMatch.result.split('-').map(Number);
      let winnerId;

      if (h > a) {
        winnerId = finalMatch.homeId;
      } else if (a > h) {
        winnerId = finalMatch.awayId;
      } else {
        return alert('Cannot settle: Final ended in a draw. Please resolve the winner first.');
      }

      const winnerTeam = globalTeams.find(t => t.id === winnerId);
      if (!winnerTeam) return alert('Winner team not found!');

      showConfirm(
        'Settle Outright Market',
        `Champion: ${winnerTeam.name}. This will pay out all winning bets and close the market. Continue?`,
        async () => {
          const betsSnap = await db.ref('outright_bets').once('value');
          const allBets = betsSnap.val() || {};
          const updates = {};

          for (const [user, bet] of Object.entries(allBets)) {
            const isWinner = bet.teamId === winnerId;
            const payout = isWinner ? bet.stake * parseFloat(bet.odds) : 0;

            // Get user credits
            const userSnap = await db.ref(`users/${user}/credits`).once('value');
            const currentCredits = userSnap.val() || 0;

            if (isWinner) {
              updates[`users/${user}/credits`] = currentCredits + payout;
              const notifKey = firebase.database().ref(`notifications/${user}`).push().key;
              updates[`notifications/${user}/${notifKey}`] = `üèÜ OUTRIGHT WIN! Your bet on ${winnerTeam.name} won! Payout: ${payout.toFixed(2)}`;
            } else {
              const notifKey = firebase.database().ref(`notifications/${user}`).push().key;
              updates[`notifications/${user}/${notifKey}`] = `Outright bet lost. ${winnerTeam.name} won the tournament.`;
            }

            // Move to history
            updates[`outright_history/${user}/${Date.now()}`] = {
              ...bet,
              winner: winnerId,
              winnerName: winnerTeam.name,
              won: isWinner,
              payout: isWinner ? payout : 0,
              settledAt: Date.now()
            };
          }

          // Clear active bets and close market
          updates['outright_bets'] = null;
          updates['outright_market/open'] = false;

          await db.ref().update(updates);
          showNotification(`Outright market settled! Champion: ${winnerTeam.name}`);
        }
      );
    }

    // User: Render the outright betting section
    function renderUserOutrightSection() {
      const section = document.getElementById('user-outright-section');
      const grid = document.getElementById('user-outright-grid');
      const statusBadge = section?.querySelector('.status-badge');
      const countdown = document.getElementById('user-outright-countdown');
      const betSlip = document.getElementById('outright-bet-slip');

      if (!section || !grid) return;

      // Always show the section
      section.style.display = 'block';

      // Check if market is open and has odds
      const hasOdds = outrightMarket.odds && Object.keys(outrightMarket.odds).length > 0;

      if (!outrightMarket.open || !hasOdds) {
        // Show closed/no tournament message
        if (statusBadge) {
          statusBadge.textContent = 'CLOSED';
          statusBadge.className = 'status-badge closed';
        }
        if (countdown) countdown.textContent = '';
        if (betSlip) betSlip.style.display = 'none';

        grid.innerHTML = `
          <div style="grid-column: 1 / -1; padding:40px 20px; text-align:center;">
            <div style="font-size:3rem; margin-bottom:15px; opacity:0.5;">üèÜ</div>
            <div style="font-size:1.1rem; color:#888; margin-bottom:8px;">No Active Tournament Betting</div>
            <div style="font-size:0.85rem; color:#666;">Check back later when a tournament is in progress</div>
          </div>
        `;
        return;
      }

      // Market is open - show status badge
      if (statusBadge) {
        statusBadge.textContent = 'BETTING OPEN';
        statusBadge.className = 'status-badge open';
      }

      // Start countdown timer and check for auto-close
      startOutrightCountdown();
      checkOutrightAutoClose();

      // Exclude Group E teams from outright betting
      const html = globalTeams
        .filter(t => t.group !== 'E' && outrightMarket.odds[t.id])
        .map(t => {
          const odds = outrightMarket.odds[t.id];
          const isSelected = selectedOutrightTeam === t.id;
          return `
            <div class="outright-team-card ${isSelected ? 'selected' : ''}" 
                 onclick="selectOutrightTeam('${t.id}', '${t.name}', ${odds})">
              <div class="team-name">${t.name}</div>
              <div class="team-odds">${odds}</div>
              <div class="team-group">Group ${t.group}</div>
            </div>
          `;
        }).join('');

      grid.innerHTML = html || '<div style="padding:20px; color:#888;">No teams available.</div>';
    }

    // User: Select a team for outright betting
    function selectOutrightTeam(teamId, teamName, odds) {
      selectedOutrightTeam = teamId;

      // Update display
      document.getElementById('outright-pick-display').innerHTML =
        `${teamName} @ <span style="color:var(--b365-accent-yellow)">${odds}</span>`;

      document.getElementById('outright-bet-slip').style.display = 'flex';

      // Update visual selection
      document.querySelectorAll('.outright-team-card').forEach(card => {
        card.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');
    }

    // User: Place outright bet
    async function placeOutrightBet() {
      if (!selectedOutrightTeam) return alert('Please select a team first.');

      const stake = parseFloat(document.getElementById('outright-stake').value);
      if (isNaN(stake) || stake <= 0) return alert('Please enter a valid stake.');

      // Check if already has an outright bet
      const existingSnap = await db.ref(`outright_bets/${currentUser}`).once('value');
      if (existingSnap.exists()) {
        return alert('You already have an active outright bet. Only one per user allowed.');
      }

      // Check balance
      const balanceSnap = await db.ref(`users/${currentUser}/credits`).once('value');
      const balance = balanceSnap.val() || 0;

      if (stake > balance) return alert('Insufficient balance!');

      const team = globalTeams.find(t => t.id === selectedOutrightTeam);
      const odds = outrightMarket.odds[selectedOutrightTeam];

      if (!team || !odds) return alert('Invalid team selection.');

      const updates = {};
      updates[`users/${currentUser}/credits`] = balance - stake;
      updates[`outright_bets/${currentUser}`] = {
        teamId: selectedOutrightTeam,
        teamName: team.name,
        odds: odds,
        stake: stake,
        placedAt: Date.now()
      };

      await db.ref().update(updates);

      // Reset selection
      selectedOutrightTeam = null;
      document.getElementById('outright-stake').value = '';
      document.getElementById('outright-bet-slip').style.display = 'none';

      showNotification(`Outright bet placed on ${team.name} to win the tournament!`);
    }

    // User: Show existing outright bet
    function renderUserExistingOutrightBet(bet) {
      const container = document.getElementById('user-outright-existing');
      const infoDiv = document.getElementById('user-outright-bet-info');
      const betSlip = document.getElementById('outright-bet-slip');

      if (!container || !infoDiv) return;

      if (!bet) {
        container.style.display = 'none';
        if (betSlip) betSlip.style.display = selectedOutrightTeam ? 'flex' : 'none';
        return;
      }

      container.style.display = 'block';
      if (betSlip) betSlip.style.display = 'none'; // Hide bet slip if already has bet

      const potential = (bet.stake * parseFloat(bet.odds)).toFixed(2);

      // Show cancel button only if betting is still open
      const cancelButton = outrightMarket.open
        ? `<button class="delete-btn" style="margin-left:15px; padding:8px 15px;" onclick="cancelOutrightBet()">Cancel Bet</button>`
        : `<span style="font-size:0.75rem; color:#888; margin-left:15px;">Betting closed</span>`;

      infoDiv.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <span style="font-size:1.1rem; font-weight:bold; color:var(--b365-bright-green);">üèÜ ${bet.teamName}</span>
            <span style="margin-left:10px; color:var(--b365-accent-yellow);">@ ${bet.odds}</span>
          </div>
          <div style="display:flex; align-items:center;">
            <div style="text-align:right;">
              <div style="font-size:0.75rem; color:#888;">Stake: ${bet.stake}</div>
              <div style="color:var(--b365-bright-green); font-weight:bold;">Potential: ${potential}</div>
            </div>
            ${cancelButton}
          </div>
        </div>
      `;
    }

    // User: Cancel outright bet
    async function cancelOutrightBet() {
      if (!outrightMarket.open) {
        return alert('Betting is closed. You cannot cancel your bet.');
      }

      showConfirm(
        'Cancel Outright Bet',
        'Are you sure you want to cancel your outright bet? Your stake will be refunded.',
        async () => {
          // Get current bet
          const betSnap = await db.ref(`outright_bets/${currentUser}`).once('value');
          const bet = betSnap.val();

          if (!bet) {
            return alert('No bet found to cancel.');
          }

          // Get current balance
          const balanceSnap = await db.ref(`users/${currentUser}/credits`).once('value');
          const currentBalance = balanceSnap.val() || 0;

          const updates = {};
          updates[`users/${currentUser}/credits`] = currentBalance + bet.stake;
          updates[`outright_bets/${currentUser}`] = null;

          await db.ref().update(updates);
          showNotification(`Outright bet cancelled. ${bet.stake} credits refunded.`);
        }
      );
    }

    // =====================================================
    // USER BETS TAB FUNCTIONS
    // =====================================================

    // Render user's active single bets
    function renderUserActiveBetsList(bets) {
      const container = document.getElementById('user-active-bets-list');
      const countEl = document.getElementById('active-bets-count');
      if (!container) return;

      if (!bets || Object.keys(bets).length === 0) {
        container.innerHTML = '<div style="color:#888; text-align:center;">No active single bets.</div>';
        if (countEl) countEl.textContent = '';
        return;
      }

      const betEntries = Object.entries(bets);
      if (countEl) countEl.textContent = `${betEntries.length} active`;

      const html = betEntries.map(([matchId, bet]) => {
        const match = globalMatches[matchId];
        const matchName = match ? `${match.home} vs ${match.away}` : 'Unknown Match';
        const potential = (bet.stake * bet.odd).toFixed(2);

        // Check if match has no result yet (can cancel)
        const canCancel = match && !match.result;
        const cancelBtn = canCancel
          ? `<button class="delete-btn" style="padding:5px 12px; font-size:0.75rem; margin-left:10px;" 
                     onclick="cancelSingleBet('${matchId}', ${bet.stake})">Cancel</button>`
          : '';

        return `
          <div class="active-bet-item">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div style="font-weight:bold; margin-bottom:4px;">${matchName}</div>
                <div style="font-size:0.85rem; color:#888;">
                  Pick: <span style="color:var(--b365-accent-yellow); font-weight:bold;">${bet.outcome}</span> 
                  @ <span style="color:var(--b365-bright-green);">${bet.odd}</span>
                </div>
              </div>
              <div style="display:flex; align-items:center;">
                <div style="text-align:right;">
                  <div style="font-size:0.8rem; color:#888;">Stake: ${bet.stake}</div>
                  <div style="color:var(--b365-bright-green); font-weight:bold;">‚Üí ${potential}</div>
                </div>
                ${cancelBtn}
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    // Cancel a single bet
    async function cancelSingleBet(matchId, stake) {
      showConfirm(
        'Cancel Bet',
        `Are you sure you want to cancel this bet? ${stake} credits will be refunded.`,
        async () => {
          const balanceSnap = await db.ref(`users/${currentUser}/credits`).once('value');
          const currentBalance = balanceSnap.val() || 0;

          const updates = {};
          updates[`users/${currentUser}/credits`] = currentBalance + stake;
          updates[`bets/${currentUser}/${matchId}`] = null;

          await db.ref().update(updates);
          showNotification(`Bet cancelled. ${stake} credits refunded.`);
        }
      );
    }

    // Render user's active outright bet in My Bets tab
    function renderUserActiveOutright(bet) {
      const container = document.getElementById('user-active-outright-display');
      if (!container) return;

      if (!bet) {
        container.innerHTML = '<div style="color:#888; text-align:center;">No active outright bet.</div>';
        return;
      }

      const potential = (bet.stake * parseFloat(bet.odds)).toFixed(2);
      container.innerHTML = `
        <div class="active-bet-item" style="background:linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-color:var(--b365-dark-green);">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div style="font-weight:bold; color:var(--b365-bright-green); font-size:1.1rem;">
                üèÜ ${bet.teamName}
              </div>
              <div style="font-size:0.85rem; color:#888; margin-top:4px;">
                Tournament Winner @ <span style="color:var(--b365-accent-yellow);">${bet.odds}</span>
              </div>
            </div>
            <div style="text-align:right;">
              <div style="font-size:0.8rem; color:#888;">Stake: ${bet.stake}</div>
              <div style="color:var(--b365-bright-green); font-weight:bold; font-size:1.1rem;">‚Üí ${potential}</div>
            </div>
          </div>
        </div>
      `;
    }

    // Render user's active parlays in My Bets tab
    function renderUserActiveParlaysList(parlays) {
      const container = document.getElementById('user-active-parlays-list');
      if (!container) return;

      if (!parlays) {
        container.innerHTML = '';
        return;
      }

      // Filter only pending parlays
      const activeParlays = Object.entries(parlays).filter(([id, p]) => p.status === 'pending');

      if (activeParlays.length === 0) {
        container.innerHTML = '';
        return;
      }

      const html = activeParlays.map(([parlayId, parlay], idx) => {
        const maxPotential = (parlay.stake * parlay.totalOdds).toFixed(2);

        // Analyze each leg's status
        let wonLegs = [];
        let lostLegs = [];
        let pendingLegs = [];
        let wonOddsProduct = 1;

        const legsAnalysis = parlay.legs.map(leg => {
          const match = globalMatches[leg.matchId];
          const matchName = match ? `${match.home} vs ${match.away}` : 'Unknown';
          let status = 'pending';
          let statusIcon = '‚è≥';

          if (match && match.result) {
            const [h, a] = match.result.split('-').map(Number);
            const actual = h > a ? '1' : h < a ? '2' : 'X';
            if (actual === leg.outcome) {
              status = 'won';
              statusIcon = '‚úÖ';
              wonLegs.push(leg);
              wonOddsProduct *= parseFloat(leg.odd);
            } else {
              status = 'lost';
              statusIcon = '‚ùå';
              lostLegs.push(leg);
            }
          } else {
            pendingLegs.push(leg);
          }

          return { ...leg, matchName, status, statusIcon };
        });

        const legsHtml = legsAnalysis.map(leg => `
          <div style="padding:4px 0; border-bottom:1px dashed #444;">
            ${leg.matchName} ‚Üí <strong>${leg.outcome}</strong> @ ${leg.odd} ${leg.statusIcon}
          </div>
        `).join('');

        // Determine parlay state
        const isLost = lostLegs.length > 0;
        const allPending = pendingLegs.length === parlay.legs.length;
        const hasWonLegs = wonLegs.length > 0 && lostLegs.length === 0;

        // Build action buttons
        let actionHtml = '';

        if (isLost) {
          // Parlay is lost - show LOST badge
          actionHtml = `
            <div style="text-align:right;">
              <div style="color:#ff4444; font-weight:bold; font-size:1.1rem;">‚ùå LOST</div>
              <div style="font-size:0.75rem; color:#888;">Stake: ${parlay.stake}</div>
            </div>
          `;
        } else if (allPending) {
          // No outcomes yet - can cancel
          actionHtml = `
            <div style="display:flex; align-items:center; gap:10px;">
              <div style="text-align:right;">
                <div style="font-size:0.8rem; color:#888;">Stake: ${parlay.stake}</div>
                <div style="color:var(--b365-bright-green); font-weight:bold;">‚Üí ${maxPotential}</div>
              </div>
              <button class="delete-btn" style="padding:5px 12px; font-size:0.75rem;" 
                      onclick="cancelParlay('${parlayId}', ${parlay.stake})">Cancel</button>
            </div>
          `;
        } else if (hasWonLegs) {
          // Some legs won, none lost - offer early cash out
          // Cash out = stake * won odds * 0.85 (15% reduction for pending legs risk)
          // But never more than max potential
          const cashOutBase = parlay.stake * wonOddsProduct * 0.85;
          const cashOutValue = Math.min(cashOutBase, parseFloat(maxPotential)).toFixed(2);

          actionHtml = `
            <div style="display:flex; align-items:center; gap:10px;">
              <div style="text-align:right;">
                <div style="font-size:0.8rem; color:#888;">Max: ${maxPotential}</div>
                <div style="font-size:0.75rem; color:#888;">${wonLegs.length}/${parlay.legs.length} won</div>
              </div>
              <button class="action-btn" style="padding:8px 15px; margin:0; font-size:0.8rem; background:linear-gradient(135deg, #FF9800 0%, #F57C00 100%);" 
                      onclick="earlyCashOut('${parlayId}', ${cashOutValue}, ${parlay.stake})">
                üí∞ Cash Out<br><span style="font-size:0.9rem; font-weight:bold;">${cashOutValue}</span>
              </button>
            </div>
          `;
        } else {
          // Standard pending state
          actionHtml = `
            <div style="text-align:right;">
              <div style="font-size:0.8rem; color:#888;">Stake: ${parlay.stake}</div>
              <div style="color:var(--b365-bright-green); font-weight:bold;">‚Üí ${maxPotential}</div>
            </div>
          `;
        }

        // Card styling based on state
        const cardStyle = isLost
          ? 'border-left:3px solid #ff4444; opacity:0.7;'
          : hasWonLegs
            ? 'border-left:3px solid #FF9800;'
            : '';

        return `
          <div class="active-bet-item" style="${cardStyle}">
            <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;" 
                 onclick="document.getElementById('parlay-legs-${idx}').style.display = document.getElementById('parlay-legs-${idx}').style.display === 'none' ? 'block' : 'none'">
              <div>
                <div style="font-weight:bold;">
                  üìä Parlay (${parlay.legs.length} legs)
                  ${isLost ? '<span style="color:#ff4444; margin-left:8px;">LOST</span>' : ''}
                  ${hasWonLegs ? '<span style="color:#FF9800; margin-left:8px;">CASH OUT AVAILABLE</span>' : ''}
                </div>
                <div style="font-size:0.85rem; color:#888;">
                  Total Odds: <span style="color:var(--b365-accent-yellow);">${parlay.totalOdds}</span>
                  <span style="margin-left:10px; font-size:0.7rem;">‚ñº click to expand</span>
                </div>
              </div>
              ${actionHtml}
            </div>
            <div id="parlay-legs-${idx}" style="display:none; margin-top:10px; padding:10px; background:#222; border-radius:4px; font-size:0.85rem;">
              ${legsHtml}
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    // Cancel a parlay bet (only when no legs have results)
    async function cancelParlay(parlayId, stake) {
      showConfirm(
        'Cancel Parlay',
        `Are you sure you want to cancel this parlay? ${stake} credits will be refunded.`,
        async () => {
          const balanceSnap = await db.ref(`users/${currentUser}/credits`).once('value');
          const currentBalance = balanceSnap.val() || 0;

          const updates = {};
          updates[`users/${currentUser}/credits`] = currentBalance + stake;
          updates[`parlays/${currentUser}/${parlayId}`] = null;

          await db.ref().update(updates);
          showNotification(`Parlay cancelled. ${stake} credits refunded.`);
        }
      );
    }

    // Early cash out for parlay with some won legs
    async function earlyCashOut(parlayId, cashOutValue, originalStake) {
      showConfirm(
        'Early Cash Out',
        `Cash out now for ${cashOutValue} credits? (Original stake: ${originalStake})`,
        async () => {
          const balanceSnap = await db.ref(`users/${currentUser}/credits`).once('value');
          const currentBalance = balanceSnap.val() || 0;

          const updates = {};
          updates[`users/${currentUser}/credits`] = currentBalance + parseFloat(cashOutValue);
          updates[`parlays/${currentUser}/${parlayId}/status`] = 'cashed_out';
          updates[`parlays/${currentUser}/${parlayId}/cashOutValue`] = parseFloat(cashOutValue);
          updates[`parlays/${currentUser}/${parlayId}/cashedOutAt`] = Date.now();

          await db.ref().update(updates);
          showNotification(`Cashed out! ${cashOutValue} credits added to your balance.`);
        }
      );
    }

    // =====================================================
    // LEADERBOARD FUNCTIONS
    // =====================================================

    function renderLeaderboard(users) {
      const container = document.getElementById('leaderboard-list');
      if (!container) return;

      if (!users || Object.keys(users).length === 0) {
        container.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">No users found.</div>';
        return;
      }

      // Sort by credits descending
      const sortedUsers = Object.entries(users)
        .map(([name, data]) => ({ name, credits: data.credits || 0 }))
        .sort((a, b) => b.credits - a.credits);

      const html = sortedUsers.map((user, index) => {
        const rank = index + 1;
        let rankClass = '';
        let rankDisplay = rank;

        if (rank === 1) { rankClass = 'gold'; rankDisplay = 'ü•á'; }
        else if (rank === 2) { rankClass = 'silver'; rankDisplay = 'ü•à'; }
        else if (rank === 3) { rankClass = 'bronze'; rankDisplay = 'ü•â'; }

        const isCurrentUser = user.name === currentUser;

        return `
          <div class="leaderboard-row ${isCurrentUser ? 'current-user' : ''}">
            <span class="leaderboard-rank ${rankClass}">${rankDisplay}</span>
            <span class="leaderboard-name">
              ${user.name}
              ${isCurrentUser ? '<span style="font-size:0.75rem; color:var(--b365-bright-green); margin-left:8px;">(You)</span>' : ''}
            </span>
            <span class="leaderboard-credits">${user.credits.toLocaleString()}</span>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    // =====================================================
    // RESOLVED BETS FUNCTIONS
    // =====================================================

    function renderUserResolvedBets(history, parlays) {
      const container = document.getElementById('user-resolved-bets-list');
      const countEl = document.getElementById('resolved-bets-count');
      if (!container) return;

      const resolvedItems = [];

      // Process single bet history
      if (history) {
        Object.entries(history).forEach(([matchId, bet]) => {
          const match = globalMatches[matchId];
          const matchName = match ? `${match.home} vs ${match.away}` : 'Unknown Match';

          resolvedItems.push({
            type: 'single',
            matchName,
            outcome: bet.pick || bet.outcome,
            odds: bet.odd,
            stake: bet.stake,
            won: bet.win, // Database uses 'win' not 'won'
            payout: bet.win ? (bet.stake * bet.odd) : 0,
            timestamp: bet.settledAt || Date.now()
          });
        });
      }

      // Process resolved parlays (won, lost, cashed_out)
      if (parlays) {
        Object.entries(parlays).forEach(([parlayId, parlay]) => {
          if (parlay.status === 'pending') return; // Skip active parlays

          const legsDesc = parlay.legs.map(leg => {
            const match = globalMatches[leg.matchId];
            return match ? `${match.home} vs ${match.away}` : 'Unknown';
          }).slice(0, 2).join(', ') + (parlay.legs.length > 2 ? ` +${parlay.legs.length - 2} more` : '');

          resolvedItems.push({
            type: 'parlay',
            legsCount: parlay.legs.length,
            legsDesc,
            totalOdds: parlay.totalOdds,
            stake: parlay.stake,
            status: parlay.status,
            won: parlay.status === 'won',
            cashedOut: parlay.status === 'cashed_out',
            payout: parlay.status === 'won' ? (parlay.stake * parlay.totalOdds) :
              parlay.status === 'cashed_out' ? parlay.cashOutValue : 0,
            timestamp: parlay.settledAt || parlay.cashedOutAt || Date.now()
          });
        });
      }

      if (resolvedItems.length === 0) {
        container.innerHTML = '<div style="color:#888; text-align:center;">No resolved bets yet.</div>';
        if (countEl) countEl.textContent = '';
        return;
      }

      // Sort by timestamp descending (most recent first)
      resolvedItems.sort((a, b) => b.timestamp - a.timestamp);

      if (countEl) countEl.textContent = `${resolvedItems.length} resolved`;

      const html = resolvedItems.map(item => {
        if (item.type === 'single') {
          const statusColor = item.won ? 'var(--b365-bright-green)' : '#ff4444';
          const statusIcon = item.won ? '‚úÖ WON' : '‚ùå LOST';
          const borderColor = item.won ? 'var(--b365-bright-green)' : '#ff4444';

          return `
            <div class="active-bet-item" style="border-left:3px solid ${borderColor}; opacity:${item.won ? 1 : 0.7};">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <div style="font-weight:bold; margin-bottom:4px;">${item.matchName}</div>
                  <div style="font-size:0.85rem; color:#888;">
                    Pick: <span style="color:var(--b365-accent-yellow);">${item.outcome}</span> 
                    @ <span style="color:#888;">${item.odds}</span>
                  </div>
                </div>
                <div style="text-align:right;">
                  <div style="font-weight:bold; color:${statusColor};">${statusIcon}</div>
                  <div style="font-size:0.8rem; color:#888;">
                    ${item.won ? `+${item.payout.toFixed(2)}` : `-${item.stake}`}
                  </div>
                </div>
              </div>
            </div>
          `;
        } else {
          // Parlay
          let statusColor, statusIcon, borderColor;
          if (item.status === 'won') {
            statusColor = 'var(--b365-bright-green)';
            statusIcon = '‚úÖ WON';
            borderColor = 'var(--b365-bright-green)';
          } else if (item.status === 'cashed_out') {
            statusColor = '#FF9800';
            statusIcon = 'üí∞ CASHED OUT';
            borderColor = '#FF9800';
          } else {
            statusColor = '#ff4444';
            statusIcon = '‚ùå LOST';
            borderColor = '#ff4444';
          }

          return `
            <div class="active-bet-item" style="border-left:3px solid ${borderColor}; opacity:${item.status !== 'lost' ? 1 : 0.7};">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <div style="font-weight:bold; margin-bottom:4px;">üìä Parlay (${item.legsCount} legs)</div>
                  <div style="font-size:0.8rem; color:#888; max-width:250px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                    ${item.legsDesc}
                  </div>
                  <div style="font-size:0.75rem; color:#666;">
                    Odds: ${item.totalOdds} | Stake: ${item.stake}
                  </div>
                </div>
                <div style="text-align:right;">
                  <div style="font-weight:bold; color:${statusColor};">${statusIcon}</div>
                  <div style="font-size:0.85rem; color:${statusColor}; font-weight:bold;">
                    ${item.payout > 0 ? `+${item.payout.toFixed(2)}` : `-${item.stake}`}
                  </div>
                </div>
              </div>
            </div>
          `;
        }
      }).join('');

      container.innerHTML = html;
    }
  </script>
</body>

</html>
